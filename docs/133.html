<html>
<head>
<title>How to install and configure NTP Server and Client on Debian - NTP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在Debian - NTP上安装和配置NTP服务器和客户端</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/install-ntp-debian/#0001-01-01">https://blog.eldernode.com/install-ntp-debian/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/484693ef670a82c6730d2563da9c5887.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2123.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How to install and configure NTP Server and Client on Debian" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2123.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2123-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2123-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2123-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2123-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2123-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2123.png"/><p>为了了解更多关于<strong>网络时间协议</strong>，在这篇文章中我们将学习<strong>如何在Debian </strong>上安装和配置NTP服务器和客户端。众所周知，时间同步非常重要，原因有很多，从应用程序时间戳到安全性再到正确的日志条目，而<strong> NTP </strong>为公司提供了一种独特的功能，可以同步公司内所有系统的时钟。</p><p>因为从故障排除的角度来看，当一个组织的系统都保持不同的时钟时间时，很难确定特定事件可能在何时以及在什么条件下发生。NTP提供了一种简单的方法来确保所有系统保持正确的时间，这反过来可以大大减轻管理员/技术支持的负担。</p><h4><span class="ez-toc-section" id="But_how_does_NTP_work"/> <span>但是NTP是怎么工作的呢？</span>T3】</h4><p><strong> NTP </strong>工作在与参考时钟同步的前提下，也称为“<strong> stratum 0 </strong>服务器。然后，所有其他NTP服务器根据它们与参考服务器的距离成为较低级别的分层服务器。</p><p>NTP链的起点是一个<strong>层1 </strong>服务器，它总是直接连接到一个<strong>层0 </strong>参考时钟。从这里，较低层的服务器通过网络连接连接到较高层的服务器。</p><p>请看下图，更好地了解本指南。</p><p><img data-lazyloaded="1" src="../Images/a8ed8dd0e03bc4274614873574ecb5e5.png" decoding="async" loading="lazy" class="aligncenter wp-image-10066 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-Diagram.jpg" alt="Diagram of NTP" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-Diagram.jpg"/></p><p> </p><p>建立一个<strong>第0层</strong>或<strong>第1层</strong>服务器会很昂贵，我们将专注于较低层的服务器设置。</p><p><strong>此外，以下文章可能有用:</strong></p><p class="fjpost-title px-0"><span> <a href="https://eldernode.com/install-ntp-server-on-linux-centos/" target="_blank" rel="noopener noreferrer">在Linux CentOS上安装NTP服务器</a> </span></p><p class="fjpost-title px-0"><span> <a href="https://eldernode.com/configure-ntp-server-in-windows-server/" target="_blank" rel="noopener noreferrer">教程在Windows Server 2019中配置NTP服务器</a>T3】</span></p><p class="fjpost-info"/><h2><span class="ez-toc-section" id="How_to_install_and_configure_NTP_Server_and_Client_on_Debian"/> <span>如何在Debian </span>上安装和配置NTP服务器和客户端<span class="ez-toc-section-end"/></h2><p>不是让网络上的所有主机都向公共NTP服务器查询，而是由一台或多台服务器联系公共NTP系统，然后为本地网络中的所有主机提供时间。加入我们来完成本指南的步骤，并学习如何在Debian上安装和配置NTP服务器和客户端。</p><div><p>为了节省网络带宽，并通过NTP限制和加密来提高安全性，最好使用内部NTP服务器。要了解这与第一张图有何不同，请参见下面的第二张图。</p><p><img data-lazyloaded="1" src="../Images/5bac673a9f18253e172ffa1d81b90992.png" decoding="async" loading="lazy" class="aligncenter wp-image-10067 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/Internal-NTP.jpg" alt="Internal Diagram of NTP" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/Internal-NTP.jpg 333w, https://blog.eldernode.com/wp-content/uploads/2020/08/Internal-NTP-300x254.jpg 300w" data-sizes="(max-width: 333px) 100vw, 333px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/Internal-NTP.jpg"/></p></div><h3/><h3><span class="ez-toc-section" id="Installation_of_NTP_Server"/> <span>安装NTP服务器</span> <span class="ez-toc-section-end"/></h3><p class="fjpost-info">首先，您需要安装NTP服务器软件来设置内部NTP结构。Debian中名为“<strong> NTP </strong>的软件包目前包含了建立NTP层次结构所需的所有服务器实用程序</p><div><pre><code class="language-bash">pt-get install ntp  dpkg --get-selections ntp          [Can be used to confirm NTP is installed]  dpkg -s ntp                        [Can also be used to confirm NTP is installed]</code></pre></div><p><span> <strong>注</strong> </span> : <strong>根</strong>或<strong>须藤</strong>访问假定。</p><p/><p/><p/><h3><span class="ez-toc-section" id="Configuration_of_NTP_Server"/><span>NTP服务器的配置</span> <span class="ez-toc-section-end"/></h3><div><p>在此步骤中，安装NTP后，您将配置要查询时间的更高层服务器。NTP的配置文件存储在“<span> <strong> /etc/ntp.conf </strong> </span>”中，可以使用任何文本编辑器进行修改。该文件将包含查询该NTP服务器的主机的特殊参数，以及更高级别服务器的完全限定域名，以及为此NTP服务器设置的限制。</p><p>现在，您可以开始配置过程了。这需要配置更高级别的服务器。默认情况下，Debian会将Debian NTP池放在配置文件中。这些对于大多数目的来说都很好，但是管理员可以访问NIST来指定某些服务器或者以循环方式使用NIST的所有服务器。</p></div><div><p>我们将配置特定的服务器。配置文件分为几个主要部分，默认情况下针对IPv4和IPv6进行配置，但是要开始配置过程，必须使用文本编辑器打开配置文件。</p></div><p>请注意，前几个部分(<strong>漂移文件</strong>、<strong>统计数据</strong>和<strong>统计数据</strong>)都被设置为默认值。但是下一部分包含更高级别的服务器，该服务器应该通过这些服务器请求时间。</p><p>每个服务器条目的语法非常简单:</p><div><pre><code class="language-bash">server &lt;fully qualified domain name&gt; &lt;options&gt;  server time.nist.gov iburst â     [sample entry]</code></pre></div><div><p>从这个列表中选择几个更高层次的服务器是一个好主意。该服务器将查询列表中的所有服务器，以确定哪一个是最可靠的。对于本教程，我们使用</p><a href="https://tf.nist.gov/tf-cgi/servers.cgi" target="_blank" rel="noopener noreferrer"> https://tf.nist.gov/tf-cgi/servers.cgi</a><p>来获得服务器。</p></div><p><span class="ez-toc-section" id="Configuration_of_NTP_Restrictions"/> <span>配置NTP限制</span> <span class="ez-toc-section-end"/></p><p>NTP限制用于<strong>允许</strong>或<strong>不允许</strong>主机与NTP服务器交互。NTP的默认设置是向任何人提供服务时间，但不允许在IPv4和IPv6连接上进行配置。</p><p>此服务器当前仅在IPv4网络上使用，因此通过两种方法禁用了IPv6。在NTP服务器上禁用IPv6的第一件事是更改守护程序启动的默认值。这是通过更改'<span> /etc/default/ntp </span>'中的行来实现的。</p><p>回到主配置文件(<span> /etc/ntp.conf </span>)，ntp守护程序将自动配置为与所有IPv4/6主机共享时间，但不允许配置。这可以通过下面两行看出:</p><h3>NTPD在允许的基础上工作，除非被拒绝。由于IPv6被禁用，可以删除“<strong> <span>【限制-6”</span></strong>行，或者用“<span> <strong> # </strong> </span>注释掉</h3><p>这将更改NTP忽略所有消息的默认行为，因为限制子句将用于微调需要访问的主机对此NTP服务器的访问。</p><div><p>为了让服务器知道谁可以向服务器查询时间，以及他们还可以对NTP服务器做什么，我们提到了一个由<strong> 172.27.0.0/16 </strong>组成的专用网络将用于构建restrict节。</p></div><pre><code class="language-bash">nano /etc/default/ntp  </code></pre><pre><code class="language-bash">NTPD_OPTS='-4 -g' [Add the '<strong> -4 </strong>' to this line to tell NTPD to only listen to IPv4]  </code></pre><p>这条线是做什么的？它通知服务器允许来自<strong> 172.27.0.0/16 </strong>网络的任何主机访问服务器一段时间。掩码后的参数有助于控制该网络中的任何主机在查询服务器时可以执行的操作。</p><figure id="attachment_12675" class="wp-caption aligncenter" aria-describedby="caption-attachment-12675"/><pre><code class="language-bash"># By default, exchange time with everybody, but don't allow configuaration.  restrict -4 default kod notrap nomodify nopeer noquery  restrict -6 default kod notrap nomodify nopeer noquery</code></pre><p>要验证更多这些限制选项，请查看下面的。</p><pre><code class="language-bash"># By default don't answer anything - HRT 04/09/2018  restrict default ignore</code></pre><p><span> <b>受限</b> </span>:表示如果客户端滥用包数速率控制，该包将被服务器丢弃。如果死亡之吻数据包被启用，它将被发送回滥用主机。管理员可以配置费率，但这里采用的是默认值。</p><p><span> <b> KOD </b> </span>:死亡之吻。如果主机违反了发送给服务器的数据包限制，服务器将向违反限制的主机发送KoD数据包作为响应。</p><pre><code class="language-bash">restrict 172.27.0.0 mask 255.255.0.0 limited kod nomodify notrap nopeer noquery</code></pre><p><span> <b> Notrap </b> </span>:拒绝模式6控制消息。这些控制消息用于远程日志程序。</p><p><span> <b> Nomodify </b> </span>:阻止会修改服务器配置的ntpq和ntpdc查询，但仍允许信息查询。</p><ul><li><span> <b> Noquery </b> </span>:该选项阻止主机向服务器查询信息。例如，如果没有此选项，主机可以使用ntpdc或ntpq来确定特定时间服务器从何处获取时间，或者从可能与之通信的其他对等时间服务器获取时间。</li><li> </li><li> </li><li><span class="ez-toc-section" id="Querying_NTP_Server_Network"/> <span>查询NTP服务器网络</span> <span class="ez-toc-section-end"/></li><li>因为这是一个适度限制的网络配置，所以该服务器想要查询的时间服务器会有一些问题。</li></ul><p>因此，需要为每个被查询的时间服务器添加一个受限语句来纠正这个问题。这些限制节确保该服务器可以访问更高级别的服务器，以获得适当的时间偏移。下面是允许先前在<span> <strong> ntp.conf </strong> </span>文件中配置的服务器的正确节。</p><p><img data-lazyloaded="1" src="../Images/a3dcd1cd6f2371be2c8e9d149a2d79d1.png" decoding="async" loading="lazy" class="aligncenter wp-image-10079 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-server-restricts-620x372-1.jpg" alt="Server Restricts of NTP" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-server-restricts-620x372-1.jpg 620w, https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-server-restricts-620x372-1-300x180.jpg 300w" data-sizes="(max-width: 620px) 100vw, 620px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-server-restricts-620x372-1.jpg"/></p><h3> </h3><p>如果您还记得，就在第三步之前，一个服务器列表被确定为该服务器要查询的主要NTP服务器。按照当前的配置，'<strong> restrict default ignore </strong>'节将阻止该服务器与配置的服务器进行通信。</p><p>这可以通过为每个服务器创建一个特定的server/restrict节来改变。这是一个简单的过程，每台服务器都必须这样做。</p><p><span> <strong>服务器129.6.15.28</strong></span>:这一行必须有IP地址而不是主机名。这是为了安全起见，有助于避免DNS受到损害的问题。</p><p><strong>r<span>129.6.15.28面具255 . 255 . 255 . 255 no modify not rap no peer no query</span></strong>:这行做的挺多的。第一部分允许服务器129.6.15.28。nomodify、nopeer、notrap和noquery限制了允许服务器(129.6.15.28)对此NTP服务器执行的操作。</p><p><b>现在，</b>系统将准备好开始记录时间。现在需要保存配置更改，并且需要重新启动NTP服务。</p><p>与已配置的NTP服务器同步，需要一段时间才能完成，但是可以使用'<strong> ntpdc </strong>或'<strong> ntpq </strong>'实用程序轻松监控该过程。</p><ul><li>请注意，这两个命令中的参数做同样的事情。'<span> -p </span>'将打印对等体列表以及当前状态，而'<span> -n </span>'将告诉实用程序显示远程服务器的IP地址，而不是主机名。</li><li><img data-lazyloaded="1" src="../Images/004e37a053d8466cad42065c83bf25d4.png" decoding="async" loading="lazy" class="aligncenter wp-image-10081 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/ntpdc-client.jpg" alt="Checking Server Information of NTP" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/ntpdc-client.jpg 581w, https://blog.eldernode.com/wp-content/uploads/2020/08/ntpdc-client-300x63.jpg 300w" data-sizes="(max-width: 581px) 100vw, 581px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/ntpdc-client.jpg"/></li></ul><pre><code class="language-bash">nslookup time-a.nist.gov    [The system will reply back with the IP address]  </code></pre><p>重要的是，这个“ntpdc”输出的一部分是IP地址的最左边，这一点很明显。星号<span> ( * ) </span>字符表示服务器已选择该服务器的时钟来同步时间。</p><pre><code class="language-bash">service ntp restart</code></pre><p><img data-lazyloaded="1" src="../Images/e10cf5a4d6a9e2c57e8bc5a111ea9989.png" decoding="async" loading="lazy" class="aligncenter wp-image-10082 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/NTPQ-client-620x118-1.jpg" alt="Provides Server Information of NTP " data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/NTPQ-client-620x118-1.jpg 620w, https://blog.eldernode.com/wp-content/uploads/2020/08/NTPQ-client-620x118-1-300x57.jpg 300w" data-sizes="(max-width: 620px) 100vw, 620px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/NTPQ-client-620x118-1.jpg"/></p><pre><code class="language-bash">ntpdc -pn   [This utility will provide basic information about the higher level NTP servers]  ntpq -pn    [This utility will provide slightly more information than 'ntpdc']</code></pre><p>让我们更详细地讨论这个输出，星号<span> ( * ) </span>字符也很重要，因为它表示同步。其他符号也有含义，例如，加号<span> ( + ) </span>表示同步的可能候选，减号<span>(–)</span>表示暂时被丢弃的异常值。减号表示特定的服务器不是最佳选择，也不意味着不会使用其他服务器。</p><p>总之，假设服务器的时区设置正确，服务器将反映正确的时间，并与上层服务器同步！此时，可以添加更多的内部服务器，网络中的“对等”或主机可以被定向到新的内部NTP服务器，而不必查询公共NTP服务器。</p><p> </p><p><span class="ez-toc-section" id="NTP_Client_Configuration"/> <span> NTP客户端配置</span> <span class="ez-toc-section-end"/></p><p>由于此服务器设置的目的是创建一个内部网络可以查询时间的<strong> Strata 2 </strong>服务器，因此在此步骤中服务器正在运行</p><p>假设一台Linux机器试图从新创建的<strong> Strata 2 </strong>服务器收集时间。Linux主机上的第一步是安装NTP包:</p><p>通过运行该程序，您可以安装刚刚安装在服务器上的相同NTP包，但这一次，NTP将被配置为查看本地服务器，而不是公共NTP服务器。在主机上，打开配置文件“<span> /etc/ntp.conf </span>”。</p><h3>这个Linux主机上的大部分配置都是相同的，只是服务器节现在指向内部服务器，如下所示。</h3><p> </p><p><img data-lazyloaded="1" src="../Images/7fa61067c4a3676ab13c26e45ad19061.png" decoding="async" loading="lazy" class="aligncenter wp-image-10084 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-Client-Configuration-473x450-1.jpg" alt="Client-Configuration" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-Client-Configuration-473x450-1.jpg 473w, https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-Client-Configuration-473x450-1-300x285.jpg 300w" data-sizes="(max-width: 473px) 100vw, 473px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/NTP-Client-Configuration-473x450-1.jpg"/></p><pre><code class="language-bash">apt-get install ntp</code></pre><p> </p><pre><code class="language-bash">nano /etc/ntp.conf</code></pre><p>接下来，保存配置并退出<strong> nano </strong>(或您使用的任何文本编辑器)。此时，客户机被配置为从新创建的服务器上监听时间！接下来重启NTP服务，并确认主机正在与新创建的Debian NTP服务器同步。</p><p><strong>注意</strong>:确保在绿色方框中替换适当的服务器名称和IP地址。</p><p>当您看到下面的截图时，您可以确保该主机正在与新创建的NTP服务器同步时钟。通过本地NTP服务器的IP地址验证星号<span> ( * ) </span>，用“<strong> ntpdc </strong>和“<strong> ntpq </strong>确认这一点。</p><p><img data-lazyloaded="1" src="../Images/16a1a1d0d19c720068a61286eba9e627.png" decoding="async" loading="lazy" class="aligncenter wp-image-10085 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/Check-NTP-Time-Synchronization-with-Ntpq.jpg" alt="Time-Synchronization" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/Check-NTP-Time-Synchronization-with-Ntpq.jpg 620w, https://blog.eldernode.com/wp-content/uploads/2020/08/Check-NTP-Time-Synchronization-with-Ntpq-300x32.jpg 300w" data-sizes="(max-width: 620px) 100vw, 620px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/Check-NTP-Time-Synchronization-with-Ntpq.jpg"/></p><p> </p><p><img data-lazyloaded="1" src="../Images/b72ab2024a9683789553829b9af28b8b.png" decoding="async" loading="lazy" class="aligncenter wp-image-10086 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/Check-NTP-Time-Synchronization-with-Ntpdc.jpg" alt="Time-Synchronization" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/Check-NTP-Time-Synchronization-with-Ntpdc.jpg 579w, https://blog.eldernode.com/wp-content/uploads/2020/08/Check-NTP-Time-Synchronization-with-Ntpdc-300x36.jpg 300w" data-sizes="(max-width: 579px) 100vw, 579px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/Check-NTP-Time-Synchronization-with-Ntpdc.jpg"/></p><pre><code class="language-bash">service ntp restart  ntpdc -pn  ntpq -pn</code></pre><p> </p><p>通过达到这一点，Debian服务器从<strong> Strata 1 </strong>服务器获取正确的时间，然后将正确的时间分发给内部网络主机。现在，可以配置其他设备来查询该NTP服务器的时间。</p><p><span> <strong>好样的</strong> </span>！这种特殊的配置已经过测试，可以在多种Cisco设备、其他Debian Linux服务器和几个基于Debian/Ubuntu的发行版上运行。</p><p> </p><p>亲爱的用户，我们希望你喜欢这个教程<strong>如何在Debian </strong>上安装和配置NTP服务器和客户端，你可以在评论区提出关于这个培训的问题，或者解决<span> <a href="https://eldernode.com/"> Eldernode </a> </span>培训领域的其他问题，请参考<span> <a href="https://eldernode.com/ask">提问页面</a> </span>部分并在其中提出你的问题。</p><p>By reaching this point, the Debian server is pulling the correct time from the <strong>Strata 1</strong> servers and then handing out the proper time to the internal network hosts. other devices can be configured to query this NTP server as well for the time now.</p><p><span><strong>Good job</strong></span>! You’re all and this particular configuration has been tested and works with multiple Cisco devices, other Debian Linux servers, and several Debian/Ubuntu-based distributions.</p><p> </p><p>Dear user, we hope you would enjoy this tutorial <strong>How to Install and Configure NTP Server and Client on Debian</strong>, you can ask questions about this training in the comments section, or to solve other problems in the field of <span><a href="https://eldernode.com/">Eldernode</a></span> training, refer to the <span><a href="https://eldernode.com/ask">Ask page</a></span> section and raise your problems in it.</p></div></div>    
</body>
</html>