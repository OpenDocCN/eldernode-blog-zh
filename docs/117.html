<html>
<head>
<title>Tutorial set up Ansible inventories - How to set up host Aliases ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>教程设置Ansible清单-如何设置主机别名ansible</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/set-up-ansible-inventories/#0001-01-01">https://blog.eldernode.com/set-up-ansible-inventories/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/0ca3413e65c4d64a3c75abb009330a06.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2118.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="Tutorial set up Ansible inventories" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2118.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2118-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2118-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2118-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2118-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2118-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2118.png"/><p>之前，我们解释了对于<span> <a href="https://eldernode.com/install-ansible-on-ubuntu-20/" target="_blank" rel="noopener noreferrer"> Ansible </a> </span>的安装。在本文中，你将回顾<strong>教程设置可变库存</strong>。首先，什么是基本可行的？Ansible 是一个现代化的配置管理工具，它简化了设置和维护远程服务器的任务，其极简设计旨在让用户快速启动和运行。其次，它是如何工作的？<strong> Ansible </strong>使用<strong>库存文件</strong>来跟踪哪些主机是您的基础架构的一部分，以及如何找到它们来运行命令和行动手册。</p><p> </p><p><strong>先决条件</strong></p><p>如果您知道以下内容，本教程可能会更有用:</p><ul><li>两台或多台主机:两台或多台远程Ubuntu 20.04服务器。</li></ul><p> </p><h2><span class="ez-toc-section" id="Tutorial_set_up_Ansible_inventories"/> <span>教程设置易变库存</span> <span class="ez-toc-section-end"/></h2><p>如果您进行搜索，您可能会发现有多种方法可以根据您的环境和项目需求来设置您的Ansible清单文件。但是在本指南中，我们将演示如何创建清单文件并将服务器组织到组和子组中，如何设置主机变量，以及如何使用模式来控制每个主机和每个组的可执行命令和行动手册的执行。</p><p> </p><h3 id="step-1-—-creating-a-custom-inventory-file"><span class="ez-toc-section" id="Creating_a_Custom_Inventory_File"/> <span>创建自定义库存文件</span> <span class="ez-toc-section-end"/></h3><p>安装完成后，您可以看到Ansible创建了一个清单文件，该文件通常位于<span><strong>/etc/ansi ble/hosts</strong></span>。这是在剧本或命令执行过程中，当自定义库存文件没有提供<span> <strong> -i </strong> </span>选项时，Ansible使用的默认位置。使用它不会有问题，使用每个项目的库存文件是一个很好的实践，可以避免在执行命令和剧本时混淆服务器。此外，拥有每个项目的清单文件还将有助于与合作者共享您的配置设置，假设您将清单文件包含在项目的代码存储库中。</p><p>要启动和保存您的Ansible文件，请访问您的个人文件夹，并创建一个新目录。</p><pre><code class="language-bash">cd ~  mkdir ansible</code></pre><p>然后，移动到该目录，使用<span> nano </span>或您选择的文本编辑器打开一个新的清单文件。</p><pre><code class="language-bash">cd ansible  nano <span class="highlight">inventory</span></code></pre><p>您的节点列表(每行一个服务器)足以设置一个功能清单文件。</p><p><span>点</span>:主机名和IP地址是可以互换的。</p><p class="code-label" title="~/ansible/inventory"><span>~/可售/库存</span></p><pre><code class="language-bash"><span>203.0.113.111  203.0.113.112  203.0.113.113  server_hostname</span></code></pre><p>当您建立了一个库存文件时，您可以使用<span><strong>ansible-inventory</strong></span>a命令来验证并获取有关您的ansi ble库存的信息。</p><pre><code class="language-bash">ansible-inventory -i inventory --list</code></pre><p title="Output"><span>输出</span></p><pre><code class="language-bash">{      "_meta": {          "hostvars": {}      },      "all": {          "children": [              "ungrouped"          ]      },      "ungrouped": {          "hosts": [              "<span>203.0.113.111</span>",              "<span>203.0.113.112</span>",              "<span>203.0.113.113</span>",              "<span>server_hostname</span>"          ]      }  }</code></pre><p>尽管您还没有在我们的库存中设置任何组，但是输出显示了Ansible自动推断的两个不同的组:<span> all </span>和<span> ungrouped </span>。</p><p>顾名思义，<span> all </span>用于指代清单文件中的所有服务器，无论它们是如何组织的。<span>未分组的</span>组用于指代未在组中列出的服务器。</p><p> </p><p class="fjtitle1 text-uppercase1"><span> <a href="https://eldernode.com/vps/" target="_blank" rel="noopener noreferrer"> <strong>购买VPS服务器</strong> </a> </span></p><p> </p><h4 id="running-commands-and-playbooks-with-custom-inventories"><span class="ez-toc-section" id="Running_Commands_and_Playbooks_with_Custom_Inventories"/> <span>运行命令和带有自定义清单的剧本</span> <span class="ez-toc-section-end"/></h4><p>使用自定义清单文件运行Ansible命令，如下所示。</p><pre><code class="language-bash">ansible all <span class="highlight">-i inventory</span> -m ping</code></pre><p>因此，它将在您的自定义清单文件中列出的所有主机的<strong>上执行<span> ping </span>模块。</strong></p><p>现在，使用自定义库存文件执行Ansible行动手册:</p><pre><code class="language-bash">ansible-playbook -i inventory playbook.yml  </code></pre><pre><code class="language-bash"/></pre><pre><code class="language-bash"/></pre><h3 id="step-2-—-organizing-servers-into-groups-and-subgroups"><span class="ez-toc-section" id="Organizing_Servers_Into_Groups_and_Subgroups"/> <span>将服务器组织成组和子组</span> <span class="ez-toc-section-end"/></h3><p>此时，您可以将服务器组织到清单文件中的不同组和子组中。它让您保持主机有序，这种做法将使您能够使用<strong>组变量</strong>，这一特性可以极大地方便使用Ansible管理多个登台环境。</p><p>一个主机可以属于多个组。以下INI格式的清单文件演示了一个包含四个组的设置:<span> webservers </span>、<span> dbservers、开发</span>和<span>生产<span>。</span> </span></p><p><strong>记住</strong>服务器是根据两种不同的品质来分组的:它们的用途，以及它们是如何被使用的。</p><p class="code-label" title="~/ansible/inventory"><span>~/可售/库存</span></p><pre><code class="language-bash">[webservers]  203.0.113.111  203.0.113.112    [dbservers]  203.0.113.113  server_hostname    [development]  203.0.113.111  203.0.113.113    [production]  203.0.113.112  server_hostname</code></pre><p>此外，如果您对该库存文件再次运行<span> ansible-inventory </span>命令，将会显示以下输出。</p><p title="Output"><span>输出</span></p><pre><code class="language-bash">{      "_meta": {          "hostvars": {}      },      "all": {          "children": [              "dbservers",              "development",              "production",              "ungrouped",              "webservers"          ]      },      "dbservers": {          "hosts": [              "203.0.113.113",              "server_hostname"          ]      },      "development": {          "hosts": [              "203.0.113.111",              "203.0.113.113"          ]      },      "production": {          "hosts": [              "203.0.113.112",              "server_hostname"          ]      },      "webservers": {          "hosts": [              "203.0.113.111",              "203.0.113.112"          ]      }  }</code></pre><p>尽管如此，您可以将多个组聚合为“父”组下的子组。然后,“父代”被称为元组。以下示例演示了使用元组组织以前库存的另一种方法，以实现可比较的、更细粒度的安排:</p><p class="code-label" title="~/ansible/inventory"><span>~/可售/库存</span></p><pre class="code-pre language-ini"><code class="language-bash">[web_dev]  203.0.113.111    [web_prod]  203.0.113.112    [db_dev]  203.0.113.113    [db_prod]  server_hostname    [webservers:children]  web_dev  web_prod    [dbservers:children]  db_dev  db_prod    [development:children]  web_dev  db_dev    [production:children]  web_prod  db_prod</code></pre><p><span>要点</span>:您拥有的服务器越多，将服务器分组或创建替代安排就越有意义，这样您就可以根据需要将服务器分组。</p><h3/><h3 id="step-3-—-setting-up-host-aliases"><span class="ez-toc-section" id="Setting_Up_Host_Aliases"/> <span>设置主机别名</span> <span class="ez-toc-section-end"/></h3><p>正如您所猜测的，我们将在这一步解释如何使用别名。您可以使用它来命名服务器，以便在以后运行命令和行动手册时引用这些服务器。</p><p>要使用别名，请在别名后包含一个名为<span> ansible_host </span>的变量，该变量包含应该响应该别名的服务器的相应IP地址或主机名:</p><p class="code-label" title="~/ansible/inventory"><span>~/可售/库存</span></p><div><pre><code class="language-bash"><span>server1 </span>ansible_host=<span>203.0.113.111</span>  <span>server2 </span>ansible_host=<span>203.0.113.112</span>  <span>server3 </span>ansible_host=<span>203.0.113.113</span>  <span>server4 </span>ansible_host=<span>server_hostname</span></code></pre><p>如果您对这个库存文件运行<span> ansible-inventory </span>命令，将会显示以下输出。</p></div><p title="Output"><span>输出</span></p><pre><code class="language-bash">{      "_meta": {          "hostvars": {              "server1": {                  "ansible_host": "203.0.113.111"              },              "server2": {                  "ansible_host": "203.0.113.112"              },              "server3": {                  "ansible_host": "203.0.113.113"              },              "server4": {                  "ansible_host": "server_hostname"              }          }      },      "all": {          "children": [              "ungrouped"          ]      },      "ungrouped": {          "hosts": [              "server1",              "server2",              "server3",              "server4"          ]      }  }</code></pre><p><strong>还记得</strong>现在服务器是如何被它们的别名引用的，而不是它们的<strong> IP地址</strong>或主机名。这使得在运行命令和行动手册时更容易定位单个服务器。</p><p> </p><h3 id="step-4-—-setting-up-host-variables"><span class="ez-toc-section" id="Setting_Up_Host_Variables"/> <span>设置主机变量</span> <span class="ez-toc-section-end"/></h3><p>此外，您将能够使用库存文件来设置变量，这些变量将在您的节点上连接和执行命令时改变Ansible的默认行为。正如您在上一步中所做的那样。如果使用别名来引用该服务器，<span> ansible_host </span>变量告诉ansible在哪里可以找到远程节点。</p><p>您可以按主机或组设置清单变量。除了定制Ansible的默认设置之外，还可以从您的行动手册中访问这些变量，这使得可以针对各个主机和组进行进一步的定制。</p><p>请看下面的示例，它定义了连接到该清单文件中列出的每个节点时的默认远程用户。</p><p class="code-label" title="~/ansible/inventory"><span>~/可售/库存</span></p><div><pre><code class="language-bash">server1 ansible_host=<span>203.0.113.111</span> <span>ansible_user=noodi</span>  server2 ansible_host=<span>203.0.113.112</span> <span>ansible_user=noodi</span>  server3 ansible_host=<span>203.0.113.113</span> <span>ansible_user=myuser</span>  server4 ansible_host=<span>server_hostname</span> <span>ansible_user=myuser</span></code></pre></div><p>然后，您可以创建一个组来聚合具有相似设置的主机，然后在组级别设置它们的变量:</p><div><p><span>点</span>:在<span> ansible-inventory </span>产生的JSON输出中的<span> _meta </span>节点中列出了所有的库存变量。</p></div><p/><p/><div><h3 id="step-5-—-using-patterns-to-target-execution-of-commands-and-playbooks"><span class="ez-toc-section" id="Using_Patterns_to_Target_Execution_of_Commands_and_Playbooks"/><span/><span class="ez-toc-section-end"/>使用模式来执行命令和剧本</h3><p>使用Ansible执行命令和剧本时，必须提供一个目标。和模式允许您将清单文件中的特定主机、组或子组作为目标。它们非常灵活，支持正则表达式和通配符。</p><div><p>考虑以下清单文件:</p></div></div><p>接下来，要执行一个仅针对生产环境中运行的数据库服务器的命令，请遵循以下示例。</p><p>认为只有<span>服务器主机名</span>符合该标准；但是，也有可能您在该组中有一个大型数据库服务器组。您可以使用以下模式，而不是分别针对每台服务器:</p><pre><code class="language-bash">ansible <span>dbservers:&amp;production</span> -m ping  </code></pre><p>这种模式只针对同时存在于<span>数据库服务器</span>和<span>生产</span>组中的服务器。</p><p><span>点</span>:如果您想做相反的事情，只针对出现在<span>数据库服务器</span>中的服务器，而不是出现在<span>生产</span>组中的<strong>服务器，您可以使用下面的模式:</strong></p><pre><code class="language-bash">ansible dbservers:!production -m ping  </code></pre><p>要了解更多关于在Ansible中运行命令和剧本时可以使用的一些不同的常见模式的例子，请注意下面的列表。</p><p><strong>图案结果目标</strong></p><p><span> all </span>清单文件中的所有主机</p><p><span>主机1 </span>单个主机(<span>主机1 </span></p><p><span>主机1:主机2</span><span>主机1 </span>和<span>主机2 </span></p><p><span> group1 </span>单个组(<span> group1 </span></p><p><span>group 1:group 2</span><span>group 1</span>和<span> group2 </span>中的所有服务器</p><p><span> group1: &amp; group2 </span>仅限于<span> group1 </span>和<span> group2 </span>中<strong>均为</strong>的服务器</p><p>第一组:！第二组服务器在<span>第一组</span>T4除了也在第二组</p><p>如果你需要更高级的模式选项，比如使用位置模式和正则表达式来定义目标，请参考<span> <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_patterns.html#advanced-pattern-options" target="_blank" rel="noopener noreferrer">关于模式</a> </span>的官方Ansible文档。</p><p><strong> <span>好样的</span> </strong>！你成功地调查了可能的存货。并了解如何将节点组织成组和子组，如何设置库存变量。另外，在运行命令和行动手册时，如何使用模式来定位不同的服务器组。</p><p>亲爱的用户，我们希望你能喜欢<strong>教程的这篇文章建立一个可行的库存</strong>，你可以在评论区提出关于这次培训的问题，或者解决<span> <a href="https://eldernode.com/">长老节点</a> </span>培训领域的其他问题，请参考<a href="https://eldernode.com/ask" target="_blank" rel="noopener noreferrer">提问页面</a>部分并在其中提出你的问题。</p></div></div>    
</body>
</html>