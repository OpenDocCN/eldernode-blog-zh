<html>
<head>
<title>How to install Varnish Cache 6 for Nginx on CentOS 8 - Nginx on CentOS 8</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在CentOS 8上为Nginx安装Varnish Cache 6-在CentOS 8上安装Nginx</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/install-varnish-nginx-centos-8/#0001-01-01">https://blog.eldernode.com/install-varnish-nginx-centos-8/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/0284728eadb853c7438e790a4dbbe972.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2114.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How to install Varnish Cache 6 for Nginx on CentOS 8" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2114.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2114-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2114-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2114-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2114-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2114-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2114.png"/><p>你可能知道清漆。然而，在本文中，您将学习如何在CentOS 8 上为Nginx安装Varnish Cache 6。Varnish Cache是一个开源、强大、快速的反向代理<strong> HTTP </strong>加速器，具有现代架构和灵活的配置语言。作为一个反向代理仅仅意味着它是一个你可以部署在你的网络服务器前面的软件，比如<strong> Nginx </strong>。接收客户端的HTTP请求并转发到源服务器进行处理。并且它将来自源服务器的响应传递给客户端。</p><h5><span class="ez-toc-section" id="But_how_does_Varnish_work"/> <span>但是清漆是怎么工作的呢？</span>T3】</h5><p>清漆在<strong> Nginx </strong>和<strong>客户</strong>之间充当中间人，但有一些业绩利益。它的主要目的是作为一个缓存引擎，让你的应用程序加载更快。它接收来自客户端的请求，并将它们转发到后端一次，以缓存所请求的内容。那么将来对完全相似内容的所有请求都将从缓存中得到服务。这使得您的web应用程序加载更快，并间接提高了您的web服务器的整体性能，因为<strong> Varnish </strong>将提供来自内存的内容，而不是Nginx处理来自存储磁盘的文件。</p><p>除了缓存，<strong> Varnish </strong>还有其他几个用例，包括一个<span> <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol" target="_blank" rel="noopener noreferrer"> HTTP </a> </span>请求路由器、负载平衡器、web应用防火墙等等。</p><p><strong> varnish </strong>使用高度可扩展的内置<strong> Varnish配置语言</strong> ( <strong> VCL </strong>)进行配置，这使您能够编写关于如何处理传入请求的策略。您可以使用它来构建定制的解决方案、规则和模块。</p><p> </p><h2><span class="ez-toc-section" id="How_to_install_Varnish_Cache_6_for_Nginx_on_CentOS_8"/> <span>如何在CentOS 8上为Nginx安装Varnish Cache 6</span>T3】</h2><p>加入我们，浏览本指南，学习在新的<strong> CentOS 8 </strong>或<strong> RHEL 8 </strong>服务器上安装<strong> Nginx </strong> web服务器和<strong> Varnish Cache 6 </strong>。</p><p>我们建议你设置一个完整的<strong> LEMP </strong>栈，而不是单独安装<strong> Nginx </strong>网络服务器，查看以下指南:</p><p class="fjpost-title px-0"><span> <a href="https://eldernode.com/install-lemp-on-centos-8/">如何在CentOS 8上安装LEMP</a>T3】</span></p><p> </p><p>还有<strong>不要</strong>错过一些相关文章:</p><p class="fjpost-title px-0"><span> <a href="https://eldernode.com/install-varnish-apache-centos/">如何在CentOS/RHEL 8 </a>上为Apache安装varnish cache】</span></p><p class="fjpost-info"/><p/><h3><span class="ez-toc-section" id="1-_Install_Nginx_Web_Server_on_CentOS_8"/> <span> 1-在CentOS 8 </span> <span class="ez-toc-section-end"/>上安装Nginx Web服务器</h3><p><strong> CentOS/RHEL 8 </strong>配有最新版本的<strong> Nginx </strong>网络服务器软件，因此请从默认存储库安装。</p><pre><code class="language-bash">dnf update  dnf install nginx  </code></pre><p>启动、启用并验证状态。安装完成后。</p><pre><code class="language-bash">systemctl start nginx  systemctl enable nginx  ystemctl status nginx</code></pre><p>要获得某个结果，请检查Nginx TCP套接字，默认情况下它运行在端口80上。</p><pre><code class="language-bash">ss -tpln</code></pre><p>正如我们在本指南开始时要求您运行防火墙，现在请确保更新防火墙。</p><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-service=http  firewall-cmd --reload</code></pre><p> </p><h3><span class="ez-toc-section" id="2-_Installing_Varnish_Cache_6_on_CentOS_8"/> <span> 2-在CentOS 8 </span> <span class="ez-toc-section-end"/>上安装清漆缓存6</h3><p><strong> CentOS/RHEL 8 </strong>默认提供了一个<strong>清漆缓存DNF </strong>模块，其中包含版本<strong> 6.0 </strong> <strong> LTS。</strong></p><p>要安装模块:</p><pre><code class="language-bash">dnf module install varnish  </code></pre><p>然后，您可以确认系统上安装的<strong>清漆</strong>的版本。</p><pre><code class="language-bash">varnishd -V    </code></pre><p>请注意，安装<strong>清漆缓存</strong>后，安装在<strong> /usr/sbin/varnishd </strong>下的主可执行命令和清漆配置文件位于<strong> /etc/varnish/ </strong>。</p><p>文件<strong> /etc/varnish/default.vcl </strong>是使用<strong> VCL </strong>编写的主清漆配置文件，<strong> /etc/varnish/secret </strong>是清漆机密文件。</p><p>现在，启动<strong> Varnish </strong>服务，使其能够在系统启动时自动启动，并确认其已启动并运行。</p><p> </p><h3><span class="ez-toc-section" id="3-_Configuring_Nginx_to_Work_with_Varnish_Cache"/> <span> 3-配置Nginx使用清漆缓存</span> <span class="ez-toc-section-end"/></h3><p>是时候向您展示如何配置<strong>清漆缓存</strong>在<strong> Nginx </strong>之前运行了。默认情况下，Nginx监听端口<strong> 80 </strong>，通常每个服务器块(或<a href="https://eldernode.com/vps/" target="_blank" rel="noopener noreferrer">虚拟主机</a>)都被配置为监听该端口。</p><p>此外，您可以查看在主配置文件(<strong> /etc/nginx/nginx.conf </strong>)中配置的默认nginx服务器块</p><pre><code class="language-bash">vi /etc/nginx/nginx.conf  </code></pre><p>如果您想在<strong> Nginx、</strong>之前运行<strong>清漆</strong>，您需要将默认Nginx端口从<strong> 80 </strong>更改为<strong> 8080 </strong>或您选择的任何其他端口。</p><p>对于您希望通过<strong> Varnish </strong>提供服务的网站或web应用程序，这应该在所有未来的服务器块配置文件(通常创建在<strong> /etc/nginx/conf.d/ </strong>下)中完成。</p><p>例如，我们的测试站点<span> eldernode.lan </span>的服务器块是<strong>/etc/nginx/conf . d/elder node . LAN . conf</strong>，其配置如下。</p><pre><code class="language-bash">server {          listen       8080;          server_name  www.eldernode.lan;          root         /var/www/html/eldernode.lan/;          location / {          }            error_page 404 /404.html;              location = /40x.html {          }          error_page 500 502 503 504 /50x.html;              location = /50x.html {          }  }</code></pre><p><span> <strong>点</strong> </span>:不要忘记通过注释掉<strong> /etc/nginx/nginx.conf </strong>文件中的配置部分来禁用默认服务器块，这使您能够开始在您的服务器上运行其他网站/应用程序，否则nginx将总是将请求定向到默认服务器块。</p><p>接下来，检查配置文件是否有错误，并重启Nginx服务以应用最近的更改。</p><pre><code class="language-bash">nginx -t  systemctl restart nginx</code></pre><p>您必须将<strong> Varnish </strong>配置为在端口<strong> 80 </strong>上运行，以便能够接收来自客户端的<strong> HTTP </strong>请求。与早期版本的<strong> Varnish缓存</strong>不同，在早期版本的<strong> Varnish </strong>环境文件(现已被弃用)中进行了此更改，在版本<strong> 6.0 </strong>及更高版本中。</p><p>之后，您应该在清漆服务文件中进行所需的更改。运行以下命令打开适当的服务文件进行编辑。</p><pre><code class="language-bash">systemctl edit --full  varnish</code></pre><p>在这里，您需要找到下面的行，并更改<span> -a </span>开关的值，该开关指定监听地址和端口。将端口设置为<strong> 80 </strong>。</p><p><strong>注意</strong>:如果不指定地址，<strong> varnishd </strong>将监听服务器上所有可用的<strong> IPv4 </strong>和<strong> IPv6 </strong>接口。</p><pre><code class="language-bash">ExecStart=/usr/sbin/varnishd -a :6081 -f /etc/varnish/default.vcl -s malloc,256m  </code></pre><p>您现在可以保存文件中的更改并退出。</p><p>接下来，您需要定义后端服务器，<strong> Varnish </strong>将访问该服务器以获取内容。您将在Varnish主配置文件中执行此操作。</p><pre><code class="language-bash">vi /etc/varnish/default.vcl</code></pre><p>让我们验证默认的后端配置部分，并将字符串“<strong> default </strong>”更改为<strong> server1。</strong>然后将端口设置为<strong> 8080 </strong>。</p><pre><code class="language-bash">backend server1 {      .host = "127.0.0.1";      .port = "8080";  }</code></pre><p>因为你在同一个服务器上运行<strong> Varnish </strong>和<strong> Nginx </strong>。如果您的Nginx web服务器运行在不同的主机上。例如，另一个地址为<strong> 10.42.0.247 </strong>的服务器，然后设置<span>。主机</span>参数。</p><pre><code class="language-bash">backend server1 {      .host = "10.42.0.247";      .port = "8080";  }</code></pre><p>您现在可以保存文件中的更改并退出。</p><p>接下来，由于Varnish服务文件中最近的更改，您需要重新加载<strong> systemd </strong> manager配置，然后重新启动Varnish服务以应用更改，如下所示。</p><pre><code class="language-bash">systemctl daemon-reload  systemctl restart varnish</code></pre><p>然后确认<strong> Nginx </strong>和<strong>清漆</strong>正在监听配置好的<strong> TCP </strong>插座。</p><pre><code class="language-bash">ss -tpln</code></pre><p> </p><p><strong> <a href="https://eldernode.com/bitcoin-vps/" target="_blank" rel="noopener noreferrer"> <span>用</span> <span>比特币</span> </a> </strong>购买VPS</p><p> </p><h3><span class="ez-toc-section" id="4-_Testing_Nginx_Varnish_Cache_Setup"/> <span> 4-测试Nginx清漆缓存设置</span> <span class="ez-toc-section-end"/></h3><p>在此步骤中，您将验证网页是否通过<strong> Varnish缓存</strong>提供，如下所示。打开web浏览器，使用服务器IP或FDQN导航。</p><p>使用您的服务器的IP地址或网站的FQDN，或者使用127.0.0.1或localhost(如果您在本地测试)。</p><pre><code class="language-bash">curl -I http:///www.tecmint.lan</code></pre><p> </p><h3><span class="ez-toc-section" id="Useful_Varnish_Cache_Administration_Utilities"/> <span>有用的清漆缓存管理实用程序</span> <span class="ez-toc-section-end"/></h3><p>遵循这一节，让我们简要地描述一下<strong> Varnish Cache </strong>附带的一些有用的实用程序，您可以用它们来控制<strong> varnishd </strong>，访问内存中的日志和总体统计数据，等等。</p><h4/><h4><span class="ez-toc-section" id="varnishadm"/> <span>瓦内萨adm </span> <span class="ez-toc-section-end"/></h4><p><strong> varnishadm </strong>一个控制正在运行的Varnish实例的工具。它建立到varnishd的CLI连接。例如，您可以使用它来列出已配置的后端，如下面的屏幕截图所示。</p><p><strong>点</strong>:阅读<strong> man varnishadm </strong>了解更多信息。</p><pre><code class="language-bash">varnishadm  varnish&gt; backend.list</code></pre><h4/><h4><span class="ez-toc-section" id="varnishlog"/> <span> varnishlog </span> <span class="ez-toc-section-end"/></h4><p><strong> varnishlog </strong>实用程序提供对特定于请求的数据的访问。它提供关于特定客户端和请求的信息。</p><p>要点:阅读<strong> man varnishlog </strong>了解更多信息。</p><pre><code class="language-bash">varnishlog    </code></pre><h4><span class="ez-toc-section" id="varnishstat"/>警告状态 <span class="ez-toc-section-end"/></h4><p>一个<strong>清漆统计</strong>或<strong>清漆统计</strong>。它通过提供对内存中统计数据的访问，如缓存命中和未命中、关于存储的信息、创建的线程、删除的对象，让您对Varnish的当前性能一目了然。</p><p>要点:阅读<strong> man varnishstat </strong>了解更多信息</p><pre><code class="language-bash">varnishstat</code></pre><p> </p><h4><span class="ez-toc-section" id="varnishtop"/>警报停止 <span class="ez-toc-section-end"/></h4><p>一个<strong> varnishtop </strong>实用程序读取共享内存日志，并显示最常出现的日志条目的连续更新列表。</p><p>要点:阅读<strong> man varnishtop </strong>了解更多信息。</p><pre><code class="language-bash">varnishtop   </code></pre><p> </p><h4><span class="ez-toc-section" id="varnishhist"/><span/><span class="ez-toc-section-end"/></h4><p>一个<strong>varnish hist</strong><strong>(varnish hist</strong>)实用程序解析清漆日志并输出一个持续更新的直方图，显示最后的<strong> n </strong>个请求的分布情况。</p><p>要点:阅读<strong> man varnishhist </strong>了解更多信息。</p><pre><code class="language-bash">varnishhist  </code></pre><p><span> <strong>好样的</strong> </span>！通过接触这一点，您已经完成了指南，并了解了如何安装<strong> Varnish Cache </strong>并在<strong> Nginx HTTP </strong>服务器前运行它，以加速<strong> CentOS/RHEL 8 </strong>中的web内容交付。</p><p>了解一下<strong>清漆缓存</strong>的主要缺点是缺乏对<strong> HTTPS </strong>的原生支持是很有用的。要在您的网站/应用程序上启用<strong> HTTPS </strong>，您需要配置一个SSL/TLS终止代理与<strong> Varnish缓存</strong>协同工作来保护您的站点。</p><p> </p><p>亲爱的用户，我们希望本教程能对你有所帮助，如有任何问题或想查看我们的用户关于本文的对话，请访问<span> <a href="https://eldernode.com/ask">提问页面</a> </span>。也为了提高自己的见识，准备了这么多有用的教程给<span> <a href="https://eldernode.com/blog/"> Eldernode </a> </span>培训。</p></div></div>    
</body>
</html>