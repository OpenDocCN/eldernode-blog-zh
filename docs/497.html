<html>
<head>
<title>How To Create An AppArmor Profile In Ubuntu 18.04 - Eldernode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在Ubuntu 18.04 - Eldernode中创建AppArmor配置文件</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/create-an-apparmor-profile-in-ubuntu-18-04/#0001-01-01">https://blog.eldernode.com/create-an-apparmor-profile-in-ubuntu-18-04/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/2a64d7e7a1c71aa68d3e513bfc981365.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/12/How-To-Create-An-AppArmor-Profile-In-Ubuntu-18.04.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How To Create An AppArmor Profile In Ubuntu 18.04" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/12/How-To-Create-An-AppArmor-Profile-In-Ubuntu-18.04.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/12/How-To-Create-An-AppArmor-Profile-In-Ubuntu-18.04-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/12/How-To-Create-An-AppArmor-Profile-In-Ubuntu-18.04-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/12/How-To-Create-An-AppArmor-Profile-In-Ubuntu-18.04-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/12/How-To-Create-An-AppArmor-Profile-In-Ubuntu-18.04-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/12/How-To-Create-An-AppArmor-Profile-In-Ubuntu-18.04-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/12/How-To-Create-An-AppArmor-Profile-In-Ubuntu-18.04.png"/><p><strong> App </strong>应用<strong>装甲</strong>是一个用于安全目的的模块。作为管理员，您需要能够使用预编程配置文件来限制程序的功能。如果你用过Ubuntu，你肯定用过它的安全特性，但是你没有被告知，因为它是默认包含的，并且在后台静默运行。让我们看看什么是AppArmor以及为什么需要创建它。加入我们这篇文章，学习如何<strong>在Ubuntu 18.04 </strong>中创建AppArmor档案。如果你正在寻找一个完美和安全的<a href="https://eldernode.com/linux-vps/" target="_blank" rel="noopener"> Linux VPS </a>，购买你首选的<a href="https://eldernode.com/ubuntu-vps/" target="_blank" rel="noopener"> Ubuntu VPS </a>包，继续阅读。</p><p>为了让本教程更好地发挥作用，请考虑以下<strong>先决条件</strong>:</p><p>拥有sudo权限的非root用户。</p><p>要进行设置，请按照我们的<a href="https://blog.eldernode.com/initial-setup-ubuntu-18/" target="_blank" rel="noopener">对Ubuntu 18.04 </a>进行初始设置。</p><h2><span class="ez-toc-section" id="Tutorial_Create_An_AppArmor_Profile_In_Ubuntu_1804"/> <strong>教程在Ubuntu 18.04中创建AppArmor配置文件</strong> <span class="ez-toc-section-end"/></h2><p>AppArmor配置文件是包含注释的简单文本文件，存储在<strong> <em> /etc/apparmor.d </em> </strong>目录中。它们提供一些功能，如网络访问、原始套接字访问，以及在匹配路径上读取、写入或执行文件的权限。如果你希望限制这些破坏性的安全漏洞，通过提供传统的Unix <strong> D </strong>授权<strong> A </strong>访问<strong> C </strong>控制模型，该方法可能是有效的。Ubuntu开发者使用AppArmor来限制动作的进程。例如，Fedora和Red Hat中的SELinux也像Ubuntu中的AppArmor一样被默认使用。它们的功能是一样的，提供<strong> M </strong>和<strong> A </strong>访问<strong> C </strong>控制。AppArmor <strong>支持</strong>对文件、Linux功能、网络、挂载、重新挂载和卸载、pivot_root、ptrace、signal、DBus和Unix域套接字的访问控制。</p><h3><span class="ez-toc-section" id="Create_an_AppArmor_profile"/>创建一个外观档案<span class="ez-toc-section-end"/></h3><p>您可以使用以下命令来检查AppArmor的<strong>状态</strong>:</p><pre><code class="language-bash">sudo apparmor_status</code></pre><p><strong>首先</strong>，要安装您想要限制的应用程序和一些有用的AppArmor实用程序，运行下面的命令:</p><pre><code class="language-bash">sudo apt install apparmor-easyprof apparmor-notify apparmor-utils certspotter</code></pre><h3><span class="ez-toc-section" id="How_to_generate_a_basic_profile"/>如何生成基本档案<span class="ez-toc-section-end"/></h3><p>建议您使用最简单的启动方法。创建骨架轮廓。然后，您可以为您的目标设置Apparmor to complain模式，以使用<em> aa-logrof </em>工具来评估拒绝。要生成框架策略，您将使用<strong> <em> aa-easyprof </em> </strong>。</p><pre><code class="language-bash">aa-easyprof /usr/bin/certspotter</code></pre><pre><code class="language-bash"># vim:syntax=apparmor  # AppArmor policy for certspotter  # ###AUTHOR###  # ###COPYRIGHT###  # ###COMMENT###</code></pre><pre><code class="language-bash">#include &lt;tunables/global&gt;    # No template variables specified    "/usr/bin/certspotter" {  #include &lt;abstractions/base&gt;    # No abstractions specified    # No policy groups specified    # No read paths specified</code></pre><pre><code class="language-bash"># No write paths specified  }</code></pre><p>将输出写入配置文件。</p><pre><code class="language-bash">aa-easyprof /usr/bin/certspotter &gt; usr.bin.certspotter  sudo mv usr.bin.certspotter /etc/apparmor.d</code></pre><p>使用下面的命令将概要文件加载到内核中:</p><pre><code class="language-bash">sudo apparmor_parser -r /etc/apparmor.d/usr.bin.certspotter</code></pre><p>我们将为certspotter生成一个外貌特征。它还没有任何配置文件，是Ubuntu中的一个新工具。certspotter所做的是监视证书透明性日志，以查看是否为监视列表中列出的域生成了新的日志。作为一名证书管理员，您需要设置一个corn作业，以便定期监控新条目。现在，让我们使用这个有用的工具。</p><p>运行certspotter会导致立即(安全)崩溃。</p><pre><code class="language-bash">certspotter  certspotter: /home/testuser/.certspotter/watchlist: open /home/testuser/.certspotter/watchlist permission denied</code></pre><p>没有机会浏览源代码，所以您可以限制它在您的系统上的内容。因为基本配置文件不允许certspotter访问它需要的资源，所以您可以查看AppArmor拒绝消息来检查这里出了什么问题。</p><h3><span class="ez-toc-section" id="What_is_AppArmor_and_Complan_Mode"/>什么是外观和投诉模式<span class="ez-toc-section-end"/></h3><p>如果您安装了audit，对于非DBus政策违规，AppArmor拒绝将被记录<em><strong>/var/log/audit/audit . log</strong>。</em>否则会记录到<em> <strong> /var/log/syslog </strong>。</em>表观拒绝率可能会在分析时造成一些问题，内核将限制它们。因此，在内核中安装auditd或调整速率限制来阻止这种情况发生:</p><pre class="p-heading--three"><code class="language-bash">sudo sysctl -w kernel.printk_ratelimit=0</code></pre><p>还有一种方法来查看表面上的否认。您可以使用aa-notify工具。你会发现这是一个非常简单的程序，可以通过查询var/log/syslog来报告任何新的AppArmor denials。再有如果你已经安装了audited，它会查询<strong><em>/var/log/audit/audit . log</em></strong>。让我们看一个例子。</p><pre><code class="language-bash">/usr/bin/aa-notify -s 1 -v</code></pre><article/><p>它会显示出最近一天所有的否认。如果您使用<strong> <em> aa-logprof </em> </strong>工具来评估AppArmor在投诉模式下生成的日志条目并开发这个配置文件，这可能是一个简单的方法。要了解如果您将certspotter的AppArmor配置文件设置为投诉模式会发生什么情况，请停留在此处。</p><pre><code class="language-bash">sudo aa-complain certspotter</code></pre><p>运行certspotter一次:</p><pre><code class="language-bash">certspotter</code></pre><p>如下所示，它会立即开始在日志中生成AppArmor条目。</p><pre><code class="language-bash">Dec 24 13:34:24 tutorials audit[18643]: AVC apparmor="ALLOWED" operation="recvmsg" profile="/usr/bin/certspotter" pid=18643 comm="certspotter" laddr=10.0.2.15 lport=46314 faddr=10.0.2.16 fport=443 family="inet" sock_type="stream" protocol=6 requested_mast="receive" denied_mask="receive"</code></pre><p>因为您尚未创建允许它访问网络的配置文件规则。</p><h3><span class="ez-toc-section" id="How_to_use_aa-logprof_to_refine_the_profile"/>如何使用aa-logprof优化概要文件<span class="ez-toc-section-end"/></h3><p>您可以通过aa-logprof解析AppArmor消息并建议策略规则。它将允许certspotter在监禁下运行。</p><article class="l-tutorial-section__content"/><pre class="l-tutorial-section__content"><code class="language-bash">sudo aa-logprof    Reading log entries from /var/log/syslog. Updating AppArmor profiles in /etc/apparmor.d. Complain-mode changes: Profile: /usr/bin/certspotter Path: /proc/sys/net/core/somaxconn New Mode: r Severity: 6 [1 - /proc/sys/net/core/somaxconn r,] (A)llow / [(D)eny] / (I)gnore / (G)lob / Glob with (E)xtension / (N) ew / Audi(t) / Abo(r)t / (F)inish A</code></pre><article/><article/><pre><code class="language-bash">Profile: /usr/bin/certspotter Path: /etc/nsswitch.conf New Mode: r Severity: unknown</code></pre><p>让certspotter读取这个文件，它指定了打开套接字连接的最大数量。键入A以允许它。</p><pre><code class="language-bash">[1 - #include &lt;abstractions/nameservice&gt;] 2 - /etc/nsswitch.conf r, (A)llow / [(D)eny] / (I)gnore / (G)lob / Glob with (E)xtension / (N) ew / Audi(t) / Abo(r)t / (F)inish A</code></pre><p> </p><p>certspotter从证书透明性日志中检索信息，它使用网络来完成这项工作。您可以随意使用现有的名称服务抽象，它允许常见的访问模式，或者您也可以特别允许这种与网络相关的首次访问。在<strong><em>/etc/apparmor . d/abstracts/name service</em></strong>中你可以查看抽象的细节。</p><article/><article><pre><code class="language-bash">Profile: /usr/bin/certspotter  Path: /proc/sys/kernel/hostname  New Mode: r  Severity: 6    [1 - /proc/sys/kernel/hostname r,]  (A)llow / [(D)eny] / (I)gnore / (G)lob / Glob with (E)xtension / (N) ew / Audi(t) / Abo(r)t / (F)inish    A</code></pre><p> </p><p>让certspotter知道系统的主机名是可以的。所以，做这个。</p><pre><code class="language-bash">Profile: /usr/bin/certspotter  Path: /home/testuser/.certspotter/watchlist  New Mode: r  Severity: 4    [1 - /home/*/.certspotter/watchlist r,]  2 - /home/testuser/.certspotter/watchlist r,  (A)llow / [(D)eny] / (I)gnore / (G)lob / Glob with (E)xtension / (N) ew / Audi(t) / Abo(r)t / (F)inish    A</code></pre></article><p> </p><p>为了确定要监视哪些域，certspotter会读取监视列表。你需要它为系统的所有用户工作，而不仅仅是为你自己。因此，第一个建议的规则比第二个效果更好。既然你知道certspotter用的是<strong> <em>。certspotter </em> </strong>目录来写它发现的信息、它的锁文件和其他数据，所以这个“r”(读)规则将是不够的。此外，您可以使用<strong> <em> @{HOME} </em> </strong>可调参数，而不是globbed路径。现在，接受它作为一个占位符，然后用一个<strong> TODO </strong>来润色它。</p><p><em>注意</em> : <em> <strong> @{HOME} </strong> </em>是一个可以在轮廓外定义和操作的变量。</p><pre><code class="language-bash">Profile: /usr/bin/certspotter  Path: /home/testuser/.certspotter/version  New Mode: r  Severity: 4</code></pre><pre><code class="language-bash">[1 - /home/*/.certspotter/version r,]  2 - /home/testuser/.certspotter/version r,  (A)llow / [(D)eny] / (I)gnore / (G)lob / Glob with (E)xtension / (N) ew / Audi(t) / Abo(r)t / (F)inish</code></pre><p>正如我们提到的，您可以修改监视列表规则，之后，您需要覆盖所有这些关于<em> <strong> HOME/中文件的条目。所以你会忽略这些建议的规则。</strong></em></p><p><rule suggestions="" for="" other="" files="" in="" omitted=""/></p><pre><code class="language-bash">Enforce-mode changes:    = Change Local Profiles =  The following local profiles were changed. Would you like to save them?    [1 - /usr/bin/certspotter]  (S)ave Changes / Save Selec(t)ed Profile / [(V)iew Changes] / View Change b/w (C)lean profiles / Abo(r)t  S</code></pre><p>一旦您保存了概要文件，<strong> <em> aa-logprof </em> </strong>将自动重新加载概要文件。它会立即关闭所有关于certspotter使用网络的信息。</p><h3><span class="ez-toc-section" id="How_to_edit_the_profile_manually"/>如何手动编辑个人资料<span class="ez-toc-section-end"/></h3><article class="l-tutorial-section__content"/><p>在这一部分，您应该返回并修改概要文件，以允许certspotter从<strong> <em> HOME/进行读写。</em>号</strong>目录。</p><pre><code class="language-bash">sudo vi /etc/apparmor.d/usr.bin.certspotter</code></pre><p>这里需要改<strong> <em> /home/*/。certspotter/watchlist r </em> </strong>，line to <em> <strong> owner @{HOME}/。certspotter/** rw，</strong> </em>。</p><p><strong> <em> ** </em> </strong> glob表示certspotter现在可以读写当前用户的<strong> <em>下的所有文件、目录和所有路径。certspotter </em>目录在自己的主目录下。是时候用你喜欢的信息修饰一下<strong> ###COMMENT### </strong>占位符了。然后，再次重新加载策略。</strong></p><pre><code class="language-bash">sudo apparmor_parser -r /etc/apparmor.d/usr.bin.certspotter</code></pre><h3 class="p-heading--three"><span class="ez-toc-section" id="AppArmor_deny_rules"/>表面上否认规则<span class="ez-toc-section-end"/></h3><p>为了确保certspotter不能从<strong> <em> HOME </em> </strong>中泄露一些数据，您需要添加一些规则。如果你添加明确的规则，他们可以防止配置文件错误，因为默认情况下，默认配置文件默认拒绝。</p><pre><code class="language-bash">deny @{HOME}/Documents/ rw,  deny @{HOME}/Private/ rw,  deny @{HOME}/Pictures/ rw,  deny @{HOME}/Videos/ rw,  deny @{HOME}/fake/ rw,  deny @{HOME}/.config/ rw,  deny @{HOME}/.ssh/ rw,  deny @{HOME}/.bashrc rw,</code></pre><p>虽然这个系统上没有假目录，但策略规则仍然有效，如果有一天它被创建了，AppArmor将对它执行规则。考虑到当您在指定目录本身时使用尾随的“/”时，AppArmor能够区分文件和目录。所以，记得重装保单。</p><pre><code class="language-bash">sudo apparmor_parser -r /etc/apparmor.d/usr.bin.certspotter</code></pre><p>要检查certspotter是否工作正常，请运行以下命令。</p><pre><code class="language-bash">/usr/bin/certspotter</code></pre><p>如果您看到它没有新的拒绝，您可以将AppArmor从该配置文件的投诉模式中取出，并将其设置为强制执行:</p><pre><code class="language-bash">sudo aa-enforce certspotter</code></pre><p>为什么拒绝规则不能被允许规则覆盖？因为你不能拒绝certspotter所有的<strong> <em> @{HOME} </em> </strong>，而只允许它访问<strong> <em> @{HOME}/。certspotter </em> </strong>。</p><p>正如项目建议的那样，您可以为certspotter添加一个玉米作业来进行最终测试。</p><pre><code class="language-bash">crontab -e  33 14 * * * /usr/bin/certspotter</code></pre><p>但是，建议您定期检查是否存在任何新的拒签。如果您希望练习不太常见的代码路径，您可以运行certspotter包测试并获得加分。</p><p>结论</p><p>在本文中，你已经学习了如何在Ubuntu 18.04中创建AppArmor配置文件。如果你已经从头到尾遵循了这个指南，你应该已经创建了你的第一个AppArmor个人资料。为了确保生成，您可以要求某人检查您的最终配置文件，以确保不授予特权。</p><p>In this article, you have learned How To Create An AppArmor Profile In Ubuntu 18.04. If you have followed from A to Z of this guide, you should have created your first AppArmor profile. To ensure the generating, you can ask someone to check your final profile for not granting the privilege.</p><article/></div></div>    
</body>
</html>