<html>
<head>
<title>How To Secure MongoDB On Ubuntu 20.04 Server - Eldernode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在Ubuntu 20.04服务器上保护MongoDB-elder node</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/secure-mongodb-ubuntu-20/#0001-01-01">https://blog.eldernode.com/secure-mongodb-ubuntu-20/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/38f2b71146ab645ec9d873174e62d528.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/09/IMG_1967-1.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How To Secure MongoDB on Ubuntu 20.04 Server" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/09/IMG_1967-1.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/09/IMG_1967-1-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/09/IMG_1967-1-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/09/IMG_1967-1-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/09/IMG_1967-1-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/09/IMG_1967-1-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/09/IMG_1967-1.png"/><p>MongoDB，也称为Mongo，是许多现代web应用程序中使用的开源文档数据库。它被归类为<a href="https://en.wikipedia.org/wiki/NoSQL" target="_blank" rel="noopener noreferrer"> NoS </a> <a href="https://en.wikipedia.org/wiki/NoSQL" target="_blank" rel="noopener noreferrer"> QL </a> <a href="https://en.wikipedia.org/wiki/NoSQL" target="_blank" rel="noopener noreferrer">数据库</a>，因为它不依赖于传统的基于表的关系数据库结构。相反，它使用带有动态模式的类似JSON的文档。</p><p>默认情况下，MongoDB没有启用身份验证，这意味着任何有权访问安装数据库的服务器的用户都可以不受限制地添加和删除数据。为了保护这个漏洞，本教程将引导您创建一个管理用户并启用身份验证。然后，您将进行测试，以确认只有这个管理用户可以访问数据库。要获得安全快速的Linux主机，请联系Eldernode团队。</p><p> </p><p> </p><p>为了让本教程更好地发挥作用，请考虑以下<strong>先决条件</strong>:</p><p>一个拥有<span> sudo </span>权限<br/>的非root用户来设置，按照我们在Ubuntu 20.04 LTS  上设置的<span> <a href="https://eldernode.com/initial-server-set-up-on-ubuntu-20-04-lts/" target="_blank" rel="noopener noreferrer">初始服务器。</a></span></p><p>MongoDB安装在您的服务器上。要在你的服务器上安装Mongo，跟随我们的教程<span> <a href="https://eldernode.com/install-mongodb-ubuntu-20/" target="_blank" rel="noopener noreferrer">如何在Ubuntu 20.04 </a> </span>上安装MongoDB。</p><p> </p><p> </p><h2><span class="ez-toc-section" id="How_To_Secure_MongoDB_On_Ubuntu_2004_Server"/> <span>如何在Ubuntu 20.04服务器上保护MongoDB</span><span class="ez-toc-section-end"/></h2><p>和我们一起看看这个指南，回顾一下如何在Ubuntu 20.04上保护MongoDB的步骤。</p><p> </p><p> </p><h3 id="step-1-—-adding-an-administrative-user"><span class="ez-toc-section" id="Step_1_How_To_Add_An_Administrative_User"/> <span>第一步:如何添加管理用户</span> <span class="ez-toc-section-end"/></h3><p>自从版本<span class="highlight"> 3.0 </span>发布以来，<strong> MongoDB </strong>守护进程被配置为只接受来自本地Unix套接字的连接，并且它不会自动向更广泛的互联网开放。但是，默认情况下，身份验证仍然是禁用的。这意味着任何可以访问安装MongoDB的服务器的用户也可以完全访问数据库。</p><p>作为保护此漏洞的第一步，您将创建一个管理用户。稍后，您将启用身份验证，并作为该管理用户连接以访问数据库。</p><p>要添加管理用户，您必须首先连接到Mongo shell。因为身份验证被禁用，所以您可以使用<span> <strong> mongo </strong> </span>命令进行身份验证，而无需任何其他选项:</p><pre><code class="language-bash">mongo</code></pre><p>Mongo shell提示符上方会有一些输出。因为您尚未启用身份验证，所以这将包括一个警告，说明没有为数据库启用访问控制，并且对数据和数据库配置的读写访问是不受限制的:</p><p title="Output"><span>输出</span></p><pre><code class="language-bash">MongoDB shell version v4.4.0     . . .     2020-06-09T13:26:51.391+0000 I  CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.  2020-06-09T13:26:51.391+0000 I  CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.     . . .    &gt;</code></pre><p>这些警告会在你启用认证后消失，但是现在，它们意味着任何可以访问你的Ubuntu服务器的人也可以控制你的数据库。</p><p>举例来说，运行Mongo的<span> show dbs </span>命令:</p><pre><code class="language-bash">&gt; show dbs</code></pre><p>该命令返回服务器上每个数据库的列表。但是，当启用了身份验证时，列表会根据Mongo用户的角色或其对特定数据库的访问级别而变化。因为身份验证被禁用，所以它将无限制地返回系统中当前的每个数据库:</p><p title="Output"><span>输出</span></p><pre><code class="language-bash">admin   0.000GB  config  0.000GB  local   0.000GB</code></pre><p>在此示例输出中，仅显示默认数据库。但是，如果您的系统中有任何保存敏感数据的数据库，任何用户都可以使用该命令找到它们。</p><p>作为缓解此漏洞的一部分，此步骤侧重于添加一个管理用户。为此，您必须首先连接到<span> <strong> admin </strong> </span>数据库。这是存储用户信息(如用户名、密码和角色)的地方:</p><pre><code class="language-bash">&gt; use admin</code></pre><p title="Output"><span>输出</span></p><pre><code class="language-bash">switched to db admin</code></pre><p>MongoDB安装了许多基于JavaScript的shell方法，可以用来管理数据库。其中之一是<span> db.createUser </span>方法，用于在运行该方法的数据库上创建新用户。</p><p>启动<span> db.createUser </span>方法:</p><pre><code class="language-bash">&gt; db.createUser(</code></pre><p>此方法要求您为用户指定用户名和密码，以及您希望用户拥有的任何角色。回想一下，MongoDB将其数据存储在类似JSON的文档中。因此，当您创建一个新用户时，您所做的就是创建一个文档，将适当的用户数据保存为单独的字段。</p><p>与JSON中的对象一样，MongoDB中的文档以花括号(<span> { </span>和<span> } </span>)开始和结束。要开始添加用户，请输入左花括号:</p><p><span class="note"> <span> <strong>注意</strong> </span>:在您输入右括号之前，Mongo不会将</span> db.createUser <span class="note">方法注册为完整的。直到您这样做，提示才会从大于号(</span> <span> <strong> &gt; </strong> </span> <span class="note">)变为省略号(</span> <span> <strong> … </strong> </span> <span class="note">)。<br/> </span></p><pre><code class="language-bash">... {</code></pre><p>接下来，输入一个<span> <strong>用户:</strong> </span>字段，将您想要的用户名作为双引号中的值，后跟一个逗号。以下示例指定用户名AdminNoodi，但是您可以输入您喜欢的任何用户名:</p><pre><code class="language-bash">... user: "<span class="highlight">AdminNoodi</span>",</code></pre><p> </p><p>接下来，输入一个<span> <strong> pwd </strong> </span>字段，用<span> passwordPrompt() </span>方法作为它的值。当您执行<span> <strong> db.createUser </strong> </span>方法时，<span> passwordPrompt() </span>方法会提示您输入密码。这比另一种方法更安全，那就是像输入用户名一样明文输入密码。</p><p><strong>注意</strong>:<span>password prompt()</span>方法只兼容MongoDB版本<span class="highlight"> 4.2 </span>及更新版本。如果您使用的是旧版本的Mongo，那么您必须用明文写出您的密码，类似于您写出用户名的方式:</p><pre><code class="language-bash">... pwd: "<span class="highlight">password</span>",</code></pre><p>请务必在该字段后面加上逗号:</p><pre><code class="language-bash">... pwd: passwordPrompt(),</code></pre><p>然后输入您希望管理用户拥有的角色。因为您正在创建一个管理用户，所以您至少应该授予他们对<span> <strong> admin </strong> </span>数据库的<span><strong>useradminany database</strong></span>角色。这将允许管理用户创建和修改新的用户和角色。因为管理用户在<span> <strong> admin </strong> </span>数据库中拥有该角色，这也将授予其对整个集群的<strong>超级用户访问权限。</strong></p><p>此外，以下示例还授予管理用户<span><strong>readWriteAnyDatabase</strong></span>角色。这使管理用户能够读取和修改集群中任何数据库上的数据，除了主要供内部使用的<span> <strong>配置</strong> </span>和<span> <strong>本地</strong> </span>数据库:</p><pre><code class="language-bash">... roles: [ { role: "userAdminAnyDatabase", db: "admin" }, "readWriteAnyDatabase" ]</code></pre><p>接下来，输入右大括号以表示文档结束:</p><pre><code class="language-bash">... }</code></pre><p>然后输入右括号关闭并执行<span> <strong> db.createUser </strong> </span>方法:</p><pre><code class="language-bash">... )</code></pre><p>总之，您的<span> <strong> db.createUser </strong> </span>方法应该是这样的:</p><pre><code class="language-bash">&gt; db.createUser(  ... {  ... user: "AdminNoodi",  ... pwd: passwordPrompt(),  ... roles: [ { role: "userAdminAnyDatabase", db: "admin" }, "readWriteAnyDatabase" ]  ... }  ... )    </code></pre><p>如果每一行的语法正确，该方法将正确执行，并提示您输入密码:</p><p title="Output"><span>输出</span></p><pre><code class="language-bash">Enter password:</code></pre><p>输入您选择的强密码。然后，您将收到一条确认消息，表明用户已被添加:</p><p title="Output"><span>输出</span></p><pre><code class="language-bash">Successfully added user: {      "user" : "AdminNoodi",      "roles" : [          {              "role" : "userAdminAnyDatabase",              "db" : "admin"          },          "readWriteAnyDatabase"      ]  }    </code></pre><p>接下来，您可以退出MongoDB客户端:</p><pre><code class="language-bash">&gt; exit</code></pre><p>此时，您的用户将被允许输入凭据。但是，在您启用身份验证并重新启动MongoDB守护进程之前，不会要求它们这样做。</p><p> </p><p> </p><p> </p><h3 id="step-2-—-enabling-authentication"><span class="ez-toc-section" id="Step_2_How_To_Enable_Authentication"/> <span>步骤二:如何启用认证</span> <span class="ez-toc-section-end"/></h3><p>要启用认证，您必须编辑MongoDB的配置文件<span><strong/></span>。一旦您启用它并重新启动Mongo服务，用户仍然可以连接到数据库，而无需进行身份验证。但是，在他们提供正确的用户名和密码之前，他们无法读取或修改任何数据。</p><p>用您喜欢的文本编辑器打开配置文件。在这里，我们将使用<span> <strong>纳米</strong> </span>:</p><pre><code class="language-bash">sudo nano /etc/mongod.conf</code></pre><p>向下滚动找到被注释掉的<span> <strong>安全</strong> </span>部分:</p><p class="code-label" title="/etc/mongod.conf">/etc/monod . conf文件</p><div title="/etc/mongod.conf"><pre><code class="language-bash">. . .  #security:    #operationProfiling:    . . .  </code></pre><p>通过删除井号(<span> # </span>)取消对该行的注释:</p><p class="code-label" title="/etc/mongod.conf">/etc/monod . conf文件</p><div title="/etc/mongod.conf"><pre><code class="language-bash">. . .  security:    #operationProfiling:    . . .    </code></pre><p>然后添加<span> <strong>授权</strong> </span>参数，设置为<span> <strong>【使能】</strong> </span>。完成后，这些行应该是这样的:</p><p class="code-label" title="/etc/mongod.conf">/etc/monod . conf文件</p><div title="/etc/mongod.conf"><pre><code class="language-bash">. . .  security:    authorization: "enabled"  . . .    </code></pre><p>注意<span> <strong>安全:</strong> </span>行开头没有空格，而<span> <strong>授权:</strong> </span>行缩进两个空格。</p><p>添加这些行之后，保存并关闭文件。如果您使用<span> <strong> nano </strong> </span>打开文件，请按下<span> <strong> CTRL + X </strong> </span>，<span> <strong> Y </strong> </span>，然后<span> <strong>回车</strong> </span>。</p><p>然后重新启动守护程序，使这些新的更改生效:</p><pre><code class="language-bash">sudo systemctl restart mongod</code></pre><p>接下来，检查服务的状态以确保它正确重启:</p><pre><code class="language-bash">sudo systemctl status mongod</code></pre><p>如果<span> <strong>重新启动</strong> </span>命令成功，您将收到输出，表明<span> mongod </span>服务是活动的，并且是最近启动的:</p></div></div></div><p title="Output"><span>输出</span></p><pre><code class="language-bash">● mongod.service - MongoDB Database Server       Loaded: loaded (/lib/systemd/system/mongod.service; enabled; vendor preset: enabled)       Active: active (running) since Tue 2020-06-09 22:06:20 UTC; 7s ago         Docs: https://docs.mongodb.org/manual     Main PID: 15370 (mongod)       Memory: 170.1M       CGroup: /system.slice/mongod.service               └─15370 /usr/bin/mongod --config /etc/mongod.conf    Jun 09 22:06:20 your_host systemd[1]: Started MongoDB Database Server.</code></pre><p>验证守护程序已备份并正在运行后，您可以测试您添加的身份验证设置是否按预期工作。</p><p> </p><p> </p><h3><span class="ez-toc-section" id="Step_3_How_To_Test_Authentication_Settings"/> <span>第三步:如何测试认证设置</span> <span class="ez-toc-section-end"/></h3><p>要开始测试您在上一步中添加的身份验证要求是否正常工作，请在不指定任何凭据的情况下进行连接，以验证您的操作确实受到了限制:</p><pre><code class="language-bash">mongo</code></pre><p>现在您已经启用了身份验证，以前遇到的警告都不会出现:</p><p title="Output"><span>输出</span></p><pre><code class="language-bash">MongoDB shell version v4.4.0  connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb  Implicit session: session { "id" : UUID("5d50ed96-f7e1-493a-b4da-076067b2d898") }  MongoDB server version: 4.4.0  &gt;</code></pre><p>再次运行<span> <strong> show dbs </strong> </span>命令，确认您的访问是否受到限制:</p><pre><code class="language-bash">&gt; show dbs</code></pre><p>回想一下第1步，您的服务器上至少有几个默认数据库。但是，在这种情况下，该命令不会有任何输出，因为您还没有被认证为特权用户。</p><p>因为这个命令不返回任何信息，所以可以肯定地说身份验证设置正在按预期工作。如果不先进行鉴定，您也不能创建用户或执行其他特权任务。</p><p>继续并退出MongoDB shell:</p><p><span class="note"> <span> <strong>注意</strong> </span>:与之前在步骤1中运行下面的</span> <span> <strong> exit </strong> </span> <span class="note">命令不同，关闭shell的另一种方法是只按</span><span><strong>CTRL+c .</strong></span><span class="note"><br/></span></p><pre><code class="language-bash">&gt; exit</code></pre><p>接下来，通过运行下面的<span> <strong> mongo </strong> </span>命令以这个用户的身份进行连接，确保您的管理用户能够正确地进行身份验证。该命令包括<span>-T5】-u</span>标志，它位于您想要连接的用户名之前。确保用您自己的管理用户的用户名替换<strong> AdminNoodi </strong>。它还包括<span> <strong> -p </strong> </span>标志，该标志将提示您输入用户密码，并将<span> <strong> admin </strong> </span>指定为创建指定用户名的认证数据库:</p><pre><code class="language-bash">mongo -u <span class="highlight">AdminNoodi</span> -p --authenticationDatabase admin</code></pre><p>出现提示时输入用户密码，然后准备好进入shell。在那里，再次尝试发出show dbs命令:</p><pre><code class="language-bash">&gt; show dbs</code></pre><p>这一次，因为您已经正确地进行了身份验证，所以该命令将成功地返回服务器上当前所有数据库的列表:</p><p title="Output"><span>输出</span></p><pre><code class="language-bash">admin   0.000GB  config  0.000GB  local   0.000GB</code></pre><p>现在，您可以确保已经成功启用了身份验证。</p><h2><span class="ez-toc-section" id="Conclusion"/>结论<span class="ez-toc-section-end"/></h2><p><span> <span>在本文中</span> <b>，</b> </span>您已经设置了一个管理MongoDB用户，您可以使用它来创建和修改新的用户和角色，或者管理您的MongoDB实例。您还配置了MongoDB实例，要求用户在与任何数据交互之前使用有效的用户名和密码进行身份验证。如果你有兴趣了解其他操作系统的更多信息，请阅读我们的文章<a href="https://blog.eldernode.com/install-mongodb-4-centos-8/" target="_blank" rel="noopener noreferrer">如何在CentOS 8中安装MongoDB 4</a>和<a href="https://blog.eldernode.com/install-mongodb-debian/" target="_blank" rel="noopener noreferrer">如何在Debian 10上安装MongoDB 4</a>。</p></div></div>    
</body>
</html>