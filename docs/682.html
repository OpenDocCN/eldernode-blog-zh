<html>
<head>
<title>Tutorial Setup IKev2 on Ubuntu 20.04 - Eldernode Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Ubuntu 20.04上的IKev2安装教程- Eldernode博客</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/setup-ikev2-on-ubuntu-20-04/#0001-01-01">https://blog.eldernode.com/setup-ikev2-on-ubuntu-20-04/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/91d1fe576862e217b66e51d793b341e3.png" data-src="https://blog.eldernode.com/wp-content/uploads/2021/03/Tutorial-Setup-IKev2-on-Ubuntu-20.04-1.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="Tutorial Setup IKev2 on Ubuntu 20.04" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2021/03/Tutorial-Setup-IKev2-on-Ubuntu-20.04-1.png 2069w, https://blog.eldernode.com/wp-content/uploads/2021/03/Tutorial-Setup-IKev2-on-Ubuntu-20.04-1-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2021/03/Tutorial-Setup-IKev2-on-Ubuntu-20.04-1-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2021/03/Tutorial-Setup-IKev2-on-Ubuntu-20.04-1-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2021/03/Tutorial-Setup-IKev2-on-Ubuntu-20.04-1-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2021/03/Tutorial-Setup-IKev2-on-Ubuntu-20.04-1-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2021/03/Tutorial-Setup-IKev2-on-Ubuntu-20.04-1.png"/><p>当今最常用的协议称为互联网密钥交换(IKE)。第一个版本发布于1998年，它的通用名称是IKEv1。应该注意的是，默认情况下，IPsec使用IKE的第一个版本。IKEv1功能升级了其隐藏部分。为了在2005年升级，IKEv2成立了。有了这次更新，该协议变得更加可靠，对DOS攻击更有弹性。IKEv2是一种基于IPsec的协议，代表Internet密钥交换版本2。它是思科和微软的联合产品，兼容多种平台。在本文中，我们要向您介绍Ubuntu 20.04 上的<strong>教程设置IKev2。需要注意的是，如果你想购买一台<a href="https://eldernode.com/ubuntu-vps" target="_blank" rel="noopener"> Ubuntu VPS </a>服务器，你可以访问<a href="https://eldernode.com/"> Eldernode </a>中提供的软件包。</strong></p><h2><span class="ez-toc-section" id="How_to_Setup_IKev2_on_Ubuntu_2004_step_by_step"/> <strong>如何在Ubuntu 20.04上一步步设置ike v2</strong><span class="ez-toc-section-end"/></h2><p>IKEv2协议是从众所周知的IPsec协议派生出来的协议之一，它很好地执行了隧道过程。针对开源平台的IKE有几个版本。IKEv2区别于其他VPN协议的最重要的优势之一是能够重新连接和重新建立连接。这意味着，如果连接中断，IKEv2可以继续连接并继续工作。虽然许多移动设备更喜欢使用L2TP/IPsec协议组合，但IKEv2也是一个很好的选择。</p><p>按照教程在<a href="https://blog.eldernode.com/tag/ubuntu/"> Ubuntu </a> 20.04上安装、配置和运行IKEv2。</p><h2><span class="ez-toc-section" id="Setup_IKev2_on_Ubuntu_2004_Ubuntu_1804"/> <strong>在Ubuntu 20.04上设置ike v2 | Ubuntu 18.04</strong><span class="ez-toc-section-end"/></h2><p>在Ubuntu 20.04上安装IKEv2并不复杂。在这篇文章中，我们将一步一步地教你如何在Ubuntu上配置和设置IKEv2 VPN服务器。和我们在一起。</p><h3><span class="ez-toc-section" id="Install_StrongSwan_on_Ubuntu_2004"/> <strong>在Ubuntu 20.04上安装strong swan</strong><span class="ez-toc-section-end"/></h3><p>第一步是安装StrongSwan。StrongSwan是一个免费的IPSec资源守护程序，必须配置为VPN服务器。然后，您需要安装公钥基础设施组件。通过这样做，您可以创建一个证书颁发机构来验证您的基础结构。使用以下命令更新本地缓存并安装软件:</p><pre><code class="language-bash">sudo apt update</code></pre><pre><code class="language-bash">sudo apt install strongswan strongswan-pki</code></pre><h3><span class="ez-toc-section" id="How_to_Create_a_Certificate_Authority_Setup_IKev2_on_Ubuntu_2004"/> <strong>如何创建认证机构(在Ubuntu 20.04上设置ike v2)</strong><span class="ez-toc-section-end"/></h3><p>现在您已经成功安装了StrongSwan，让我们继续创建证书。请注意，IKEv2服务器需要一个证书来向客户端标识自己。现在您已经成功安装了StrongSwan，让我们继续创建证书。<strong> strongswan-pki </strong>包附带了一个工具，用于生成认证参考和服务器认证，以帮助用户创建认证。</p><p>您必须首先创建多个目录来保存您正在处理的资源。需要注意的是，目录结构与<strong> /etc/ipsec.d </strong>中的部分目录兼容。所以我们最终会将所有创建的项目移动到哪里。在这里，我们决定锁定许可证，以防止其他用户看到私人文件。为此，请使用以下命令:</p><pre><code class="language-bash">mkdir -p ~/pki/{cacerts,certs,private}</code></pre><pre><code class="language-bash">chmod 700 ~/pki</code></pre><p>现在你需要生成一个<strong>根密钥</strong>。根密钥是4096位RSA密钥，用于签署根证书引用。因此，您可以执行以下命令来生成密钥:</p><pre><code class="language-bash">ipsec pki --gen --type rsa --size 4096 --outform pem &gt; ~/pki/private/ca-key.pem</code></pre><p>成功创建密钥后，现在需要运行以下命令来创建根证书引用，并使用此密钥对根证书进行签名:</p><pre><code class="language-bash">ipsec pki --self --ca --lifetime 3650 --in ~/pki/private/ca-key.pem \</code></pre><pre><code class="language-bash">--type rsa --dn "CN=VPN root CA" --outform pem &gt; ~/pki/cacerts/ca-cert.pem</code></pre><h3><span class="ez-toc-section" id="How_to_Generate_a_Certificate_for_the_VPN_Server"/> <strong>如何为VPN服务器生成证书</strong> <span class="ez-toc-section-end"/></h3><p>在上一节中激活并设置了根证书许可证后，现在可以创建VPN服务器可以使用的证书了。应该注意，该证书允许客户端使用CA认证来验证服务器。为此，首先使用以下命令为VPN服务器创建一个私钥:</p><pre><code class="language-bash">ipsec pki --gen --type rsa --size 4096 --outform pem &gt; ~/pki/private/server-key.pem</code></pre><p>在下一步中，您需要创建VPN服务器证书，并使用您在上一步中创建的证书参考密钥对其进行签名。因此，您必须按顺序执行以下命令。</p><p><em> <strong>注意:</strong> </em>您必须在以下命令中将常用名(<strong> CN </strong>)和主题备用名(<strong> SAN </strong>)更改为您的VPN服务器的DNS或IP地址。</p><pre><code class="language-bash">ipsec pki --pub --in ~/pki/private/server-key.pem --type rsa \</code></pre><pre><code class="language-bash">| ipsec pki --issue --lifetime 1825 \</code></pre><pre><code class="language-bash">--cacert ~/pki/cacerts/ca-cert.pem \</code></pre><pre><code class="language-bash">--cakey ~/pki/private/ca-key.pem \</code></pre><pre><code class="language-bash">--dn "CN=server_domain_or_IP" --san "server_domain_or_IP" \</code></pre><pre><code class="language-bash">--flag serverAuth --flag ikeIntermediate --outform pem \</code></pre><pre><code class="language-bash">~/pki/certs/server-cert.pem</code></pre><p>现在您已经创建了StrongSwan所需的所有<strong> TLS/SSL </strong>文件，您可以将这些文件移动到<strong> /etc/ipsec.d </strong>:</p><pre><code class="language-bash">sudo cp -r ~/pki/* /etc/ipsec.d/</code></pre><h2><span class="ez-toc-section" id="How_to_Configuring_StrongSwan"/> <strong>如何配置strong swan</strong>T3】</h2><p>让我们先备份该文件以供参考，然后使用以下命令从头开始:</p><pre><code class="language-bash">sudo mv /etc/ipsec.conf{,.original}</code></pre><p>在下一步中，您可以通过键入以下命令创建并打开一个新的空配置文件:</p><pre><code class="language-bash">sudo nano /etc/ipsec.conf</code></pre><p>您首先需要告诉StrongSwan记录守护进程状态，并允许重复连接来修复bug。因此您需要将以下命令添加到<strong> /etc/ipsec.conf </strong>文件中:</p><pre><code class="language-bash">config setup  charondebug="ike 1, knl 1, cfg 0"  uniqueids=no</code></pre><p>下一步是为VPN创建一个配置部分。strong还必须通知Swan创建IKEv2 VPN隧道。然后有必要在启动时自动加载这个配置部分。将以下几行添加到文件中:</p><pre><code class="language-bash">. . .  conn ikev2-vpn  auto=add  compress=no  type=tunnel  keyexchange=ikev2  fragmentation=yes  forceencaps=yes</code></pre><p>请注意，如果客户端意外断开连接，您必须配置死对等连接以清除“悬空”连接:</p><pre><code class="language-bash">. . .  conn ikev2-vpn  . . .  dpdaction=clear  dpddelay=300s  rekey=no</code></pre><p>接下来，您需要配置IPSec服务器端参数:</p><pre><code class="language-bash">conn ikev2-vpn  . . .  left=%any  <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="abc7cecddfc2cf96ebd8ced9ddced9">[email protected]</a>_domain_or_IP  leftcert=server-cert.pem  leftsendcert=always  leftsubnet=0.0.0.0/0</code></pre><p>这里，您需要使用以下命令配置客户端IPSec参数，例如私有IP地址和DNS服务器的范围:</p><pre><code class="language-bash">. . .  conn ikev2-vpn  . . .  right=%any  rightid=%any  rightauth=eap-mschapv2  rightsourceip=10.10.10.0/24  rightdns=8.8.8.8,8.8.4.4  rightsendcert=never</code></pre><p>要在连接客户时接收凭据，您必须输入以下命令:</p><pre><code class="language-bash">. . .  conn ikev2-vpn  . . .  eap_identity=%identity</code></pre><p>最后，您需要<strong>保存</strong>文件并退出。</p><h3><span class="ez-toc-section" id="Configuring_VPN_Authentication"/> <strong>配置VPN认证</strong> <span class="ez-toc-section-end"/></h3><p>在上一节中，我们成功地配置了VPN服务器。但是由于还没有配置凭证，这里我们需要在一个特殊的配置文件<strong> ipsec.secrets </strong>中配置几项。使用所需的编辑器打开机密文件:</p><pre><code class="language-bash">sudo nano /etc/ipsec.secrets</code></pre><p>通过在配置文件中添加以下命令，告诉StrongSwan在哪里可以找到您的私钥:</p><pre><code class="language-bash">: RSA "server-key.pem"</code></pre><p>在下一步中，您必须使用以下命令定义用户信息:</p><pre><code class="language-bash">your_username : EAP "your_password"</code></pre><p><strong>保存</strong>配置文件并退出。然后，要应用更改，您必须使用以下命令<strong>重启</strong>系统:</p><pre><code class="language-bash">sudo systemctl restart strongswan</code></pre><h3><span class="ez-toc-section" id="How_to_Configure_the_Firewall_and_Kernel_IP_Forwarding"/> <strong>如何配置防火墙和内核IP转发</strong> <span class="ez-toc-section-end"/></h3><p>在本节中，我们打算完成StrongSwan配置，以配置防火墙来允许VPN流量通过它。为此，您必须执行以下命令:</p><pre><code class="language-bash">sudo ufw allow OpenSSH</code></pre><pre><code class="language-bash">sudo ufw enable</code></pre><p>使用以下命令添加一个规则，以允许UDP流量到达标准IPSec、500和4500端口:</p><pre><code class="language-bash">sudo ufw allow 500,4500/udp</code></pre><p>要路由和发送IPSec数据包，您需要打开一个UFW配置文件并添加一些低级策略。请注意，您必须首先使用以下命令来找出服务器上用于访问互联网的网络接口:</p><pre><code class="language-bash">ip route | grep default</code></pre><p>这里重要的一点是，你的公共接口应该遵循单词“<strong> dev </strong>”。例如，以下输出显示了一个名为<strong> eth0 </strong>的接口:</p><pre><code class="language-bash">default via 203.0.113.7 dev eth0 proto static</code></pre><p>下一步是在文本编辑器中打开<strong> /etc/ufw/before.rules </strong>文件:</p><pre><code class="language-bash">sudo nano /etc/ufw/before.rules</code></pre><p>下一步是在文件顶部附近(在*filter行之前)添加以下配置:</p><p><img data-lazyloaded="1" src="../Images/0ae314b4e88c5db63a9c3ad392213b70.png" decoding="async" loading="lazy" class="alignnone wp-image-27441 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-configuration.png" alt="ikev2 configuration" data-srcset="https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-configuration.png 827w, https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-configuration-300x139.png 300w, https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-configuration-768x355.png 768w" data-sizes="(max-width: 827px) 100vw, 827px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-configuration.png"/></p><p>您必须更改上述配置中的每个<strong> eth0 </strong>实例，以使您找到的接口名称与IP路径相匹配。现在是时候在*filter和chain定义行之后使用以下命令添加另一个配置块了:</p><p><img data-lazyloaded="1" src="../Images/40cd05534ada6cea796b4c7112846b04.png" decoding="async" loading="lazy" class="alignnone wp-image-27442 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-config-on-ubuntu-20.04.png" alt="ikev2 config on ubuntu 20.04" data-srcset="https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-config-on-ubuntu-20.04.png 829w, https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-config-on-ubuntu-20.04-300x80.png 300w, https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-config-on-ubuntu-20.04-768x204.png 768w" data-sizes="(max-width: 829px) 100vw, 829px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2021/03/ikev2-config-on-ubuntu-20.04.png"/></p><p>完成上述更改后，<strong>保存</strong>文件并退出。</p><p>为了能够从一个接口路由到另一个接口，您需要使用以下命令打开<strong> UFW内核</strong>配置文件，并更改一些网络内核参数:</p><pre><code class="language-bash">sudo nano /etc/ufw/sysctl.conf</code></pre><p>下面的代码突出显示了您需要对文件进行的更改:</p><p><img data-lazyloaded="1" src="../Images/de61f23a094cf0a7fb871ad75be62f54.png" decoding="async" loading="lazy" class="alignnone wp-image-27443 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-configure-ikev2-on-ubuntu.png" alt="how to configure ikev2 on ubuntu" data-srcset="https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-configure-ikev2-on-ubuntu.png 826w, https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-configure-ikev2-on-ubuntu-300x133.png 300w, https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-configure-ikev2-on-ubuntu-768x340.png 768w" data-sizes="(max-width: 826px) 100vw, 826px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-configure-ikev2-on-ubuntu.png"/></p><p>完成更改后，<strong>保存</strong>文件并退出。最后，您可以通过禁用并重新启用防火墙来启用所有更改。为此，您必须使用以下命令。</p><p><em> <strong>注意:</strong> </em>执行以下命令后，会要求您确认进程。键入<strong> Y </strong>用新设置重新启用UFW。</p><pre><code class="language-bash">sudo ufw disable</code></pre><pre><code class="language-bash">sudo ufw enable</code></pre><h2><span class="ez-toc-section" id="How_to_Connect_to_IKEv2_from_Ubuntu_Linux"/> <strong>如何从Ubuntu Linux </strong>连接IKEv2<span class="ez-toc-section-end"/></h2><p>以下是如何通过Ubuntu 20.04连接到IKEv2的方法。您可以按照以下步骤，使用“管理StrongSwan即服务”方法连接到IKEv2。您必须首先使用以下命令更新本地包缓存:</p><pre><code class="language-bash">sudo apt update</code></pre><p>然后，您需要运行以下命令来<strong>安装StrongSwan </strong>和相关软件:</p><pre><code class="language-bash">sudo apt install strongswan libcharon-extra-plugins</code></pre><p>接下来，您需要将CA证书复制到<strong> /etc/ipsec.d/cacerts </strong>:</p><pre><code class="language-bash">sudo cp /tmp/ca-cert.pem /etc/ipsec.d/cacerts</code></pre><p>另一个重要的步骤是<strong>禁用StrongSwan </strong>，这样VPN就不会自动启动。为此，您需要从以下命令中获得帮助:</p><pre><code class="language-bash">sudo systemctl disable --now strongswan</code></pre><p>现在您需要在<strong> /etc/ipsec.secrets </strong>文件中配置您的VPN用户名和密码:</p><pre><code class="language-bash">your_username : EAP "your_password"</code></pre><p>最后，您需要如下编辑<strong> /etc/ipsec.conf </strong>文件来定义您的配置:</p><p><img data-lazyloaded="1" src="../Images/ba8ddea13d94bf45f280e0c5be34ef4a.png" decoding="async" loading="lazy" class="alignnone wp-image-27445 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-connect-ikev2-on-ubuntu-20.04.png" alt="how to connect ikev2 on ubuntu 20.04" data-srcset="https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-connect-ikev2-on-ubuntu-20.04.png 828w, https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-connect-ikev2-on-ubuntu-20.04-300x117.png 300w, https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-connect-ikev2-on-ubuntu-20.04-768x300.png 768w" data-sizes="(max-width: 828px) 100vw, 828px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2021/03/how-to-connect-ikev2-on-ubuntu-20.04.png"/></p><p>您可以使用以下命令分别将连接到虚拟专用网<strong>和<strong>断开</strong>:</strong></p><pre><code class="language-bash">sudo systemctl start strongswan</code></pre><pre><code class="language-bash">sudo systemctl stop strongswan</code></pre><h2><span class="ez-toc-section" id="Conclusion"/>结论<span class="ez-toc-section-end"/></h2><p>像任何其他VPN协议一样，IKEv2负责在用户和VPN服务器之间创建安全隧道。这个过程，首先是通过认证用户和服务器来完成的。然后商定使用哪种加密方法。在这篇文章中，我们试图一步一步地让你熟悉Ubuntu 20.04上的教程设置IKev2。如果你愿意，可以参考文章<a href="https://blog.eldernode.com/how-to-setup-ikev2-on-centos-8-step-by-step/">如何在centos 8 </a>上设置IKev2。</p></div></div>    
</body>
</html>