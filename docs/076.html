<html>
<head>
<title>How to secure Nginx web server with Let's Encrypt on Debian 10 - Eldernode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在Debian 10 - Eldernode上使用Let's Encrypt保护Nginx web服务器</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/secure-nginx-encrypt-debian-10/#0001-01-01">https://blog.eldernode.com/secure-nginx-encrypt-debian-10/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/80c6c47823fb0c5f0fb2797815cce27b.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_1995.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How to secure Nginx web server with Let's Encrypt on Debian 10" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_1995.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_1995-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_1995-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_1995-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_1995-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_1995-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_1995.png"/><p>Let's Encrypt是一个证书颁发机构(CA ),它提供了一种简单的方法来获取和安装免费的<a href="https://eldernode.com/how-to-install-and-activate-the-ssl-certificate/" target="_blank" rel="noopener noreferrer"> TLS/SSL证书</a>,从而在web服务器上实现加密的HTTPS。它通过提供一个软件客户端<span> <a href="https://certbot.eff.org/" target="_blank" rel="noopener noreferrer"> Certbot </a> </span>来简化这个过程，这个客户端试图自动化大部分(如果不是全部)所需的步骤。目前，获得和安装证书的整个过程在Apache和Nginx上都是完全自动化的。在接下来的内容中，您将使用Certbot为Debian 10上的Nginx获取一个免费的SSL证书，并将您的证书设置为自动更新。</p><p>为了让你的学习更好地进行，选择你自己的<a href="https://eldernode.com/ubuntu-vps/" target="_blank" rel="noopener noreferrer"> Ubuntu VPS服务器</a>并立即激活。</p><p> </p><p>为了让本教程更好地发挥作用，请考虑以下<strong>先决条件</strong>:</p><p><span> <b> 1- </b>一个</span>拥有<span> <strong> sudo </strong> </span>权限和防火墙的非root用户。</p><p><strong> 2- </strong>一台Debian 10服务器，按照我们<span> <a href="https://eldernode.com/initial-setup-with-debian-10/" target="_blank" rel="noopener noreferrer">与Debian 10 </a> </span>的初始设置进行设置。</p><p><strong> 3- </strong>一个完全注册的域名。你可以在<strong> Namecheap </strong>上购买一个域名，在<strong> Freenom </strong>上免费获得一个，或者使用你选择的域名注册商。</p><p><strong> 4- </strong>为您的服务器设置的以下两个DNS记录。</p><p><strong> 5- </strong>一个带有your_domain的记录，指向你的服务器的公共IP地址。</p><p><strong> 6- </strong>一条www.your_domain指向你的服务器公共IP地址的记录。</p><p><strong> 7- </strong>按照如何在Debian 10  上<span> <a href="https://eldernode.com/install-nginx-debian-10/" target="_blank" rel="noopener noreferrer">安装Nginx来安装Nginx。确保您的域有一个<strong>服务器块</strong>。本教程将以<strong><span>/etc/nginx/sites-available</span>/your _ domain</strong>为例。</a></span></p><p> </p><p> </p><h2><span class="ez-toc-section" id="How_to_secure_web_server_Nginx_with_Lets_Encrypt_on_Debian_10"/>如何在Debian 10上用Let's Encrypt保护网络服务器Nginx】</h2><div class="fjpost-info"><p>在本指南中，您将使用一个单独的Nginx服务器块文件，而不是默认文件。<span> <a href="https://eldernode.com/install-nginx-debian-10/" target="_blank" rel="noopener noreferrer">我们建议</a> </span>为每个域创建新的Nginx服务器块文件，因为这有助于避免常见错误，并保留默认文件作为后备配置。所以，我们来回顾一下这个教程的步骤，来完整的学习一下。</p></div><p> </p><p> </p><h3 id="step-1-—-installing-certbot"><span class="ez-toc-section" id="Step_1_-_How_To_install_Certbot"/>步骤1–如何安装Certbot <span class="ez-toc-section-end"/></h3><p class="fjpost-info">要开始使用Let's Encrypt来获取SSL证书，需要在您的服务器上安装Certbot软件。当然，你必须从Debian仓库安装<strong><span>python 3-cert bot-nginx</span></strong>包，这样你就可以安装和使用<strong> Cerbot的nginx插件</strong>。</p><div><p>在安装<span><strong>python 3-cert bot-nginx</strong></span>包之前，更新你的包列表:</p></div><pre><code class="language-bash">sudo apt update</code></pre><p>接下来，安装<span><strong>python 3-cert bot-nginx</strong></span>包的依赖项，其中包括<span> <strong> python3-acme </strong> </span>，<span><strong>python 3-cert bot</strong></span>，<span> <strong> python3-mock </strong> </span>，<span><strong>python 3-OpenSSL</strong></span>，<span> <strong> python3-pkg-resources</strong></span></p><pre><code class="language-bash">sudo apt install python3-acme python3-certbot python3-mock python3-openssl python3-pkg-resources python3-pyparsing python3-zope.interface</code></pre><p>接下来，安装<span><strong>python 3-cert bot-nginx</strong></span>包:</p><pre><code class="language-bash">sudo apt install python3-certbot-nginx</code></pre><p> </p><p> </p><p> </p><h3 id="step-2-—-confirming-nginx-39-s-configuration"><span class="ez-toc-section" id="Step_2_-_How_To_Confirm_Nginxs_Configuration"/>步骤2–如何确认Nginx的配置<span class="ez-toc-section-end"/></h3><p>在这一步中，您看到Certbot现在已经可以使用了，但是为了让它为Nginx配置SSL，我们需要验证Nginx的一些配置。因此，Certbot需要能够在Nginx配置中找到正确的<span> <strong>服务器</strong> </span>块，以便能够自动配置SSL。具体来说，它通过查找与您请求的域相匹配的<span> <strong> server_name </strong> </span>指令来做到这一点。</p><p>如果您遵循了Nginx安装教程 中的<span> <a href="https://eldernode.com/install-nginx-debian-10/" target="_blank" rel="noopener noreferrer">服务器块设置步骤，您应该在<span><strong>/etc/Nginx/sites-available/your _ domain</strong></span>中为您的域设置一个服务器块，并且已经适当地设置了<span> <strong> server_name </strong> </span>指令。</a></span></p><p>要进行检查，请使用<span> <strong> nano </strong> </span>或您喜欢的文本编辑器打开您的域的服务器块文件:</p><pre><code class="language-bash">sudo nano /etc/nginx/sites-available/your_domain</code></pre><p>然后，找到已有的<span> <strong> server_name </strong> </span>行。它应该是这样的:</p><p class="code-label" title="/etc/nginx/sites-available/your_domain">/etc/nginx/sites-available/your _ domain</p><p><strong>如果</strong>出现了，<strong>退出</strong>你的编辑器，继续下一步。</p><p><strong>如果</strong>不匹配，<strong>更新</strong>使其匹配。然后保存文件，退出编辑器，并验证配置编辑的语法:</p><pre><code class="language-bash">sudo nginx -t</code></pre><p>但是，如果您得到一个错误，重新打开服务器块文件，并检查任何打字错误或丢失的字符。一旦您的配置文件语法正确，重新加载Nginx以加载新的配置:</p><pre><code class="language-bash">sudo systemctl reload nginx</code></pre><p>Certbot现在可以找到正确的<span> <strong>服务器</strong> </span>块并更新它。</p><pre><code class="language-bash"/></pre><p> </p><p> </p><h3 id="step-3-—-allowing-https-through-the-firewall"><span class="ez-toc-section" id="Step_3_-_How_To_Allow_HTTPS_Through_the_Firewall"/>步骤3–如何允许HTTPS通过防火墙<span class="ez-toc-section-end"/></h3><p>如果您启用了<span> <strong> ufw </strong> </span>防火墙，如先决条件指南中所建议的，您需要调整设置以允许HTTPS流量。</p><p>使用下面的命令查看当前设置。</p><pre><code class="language-bash">sudo ufw status</code></pre><p title="Output"><span>输出</span></p><pre><code class="language-bash">Status: active    To                         Action      From  --                         ------      ----  OpenSSH                    ALLOW       Anywhere                    Nginx HTTP                 ALLOW       Anywhere                    OpenSSH (v6)               ALLOW       Anywhere (v6)               Nginx HTTP (v6)            ALLOW       Anywhere (v6)</code></pre><p>接收上述输出意味着，只有HTTP流量被允许到web服务器。</p><p>并且要让HTTPS流量进入，允许<span> <strong> Nginx完全</strong> </span>配置文件并删除多余的<span> <strong> Nginx HTTP </strong> </span>配置文件余量:</p><pre><code class="language-bash">sudo ufw allow 'Nginx Full'  sudo ufw delete allow 'Nginx HTTP'</code></pre><p>您的状态现在应该是这样的:</p><pre><code class="language-bash">sudo ufw status</code></pre><p title="Output"><span>输出</span></p><pre><code class="language-bash">Status: active    To                         Action      From  --                         ------      ----  OpenSSH                    ALLOW       Anywhere  Nginx Full                 ALLOW       Anywhere  OpenSSH (v6)               ALLOW       Anywhere (v6)  Nginx Full (v6)            ALLOW       Anywhere (v6)</code></pre><h2><span class="ez-toc-section" id="Step_4_-_How_To_Obtain_An_SSL_Certificate"/>步骤4–如何获得SSL证书<span class="ez-toc-section-end"/></h2><h2>Certbot提供了多种通过插件获取SSL证书的方式。Nginx插件将负责重新配置Nginx，并在必要时重新加载配置。要使用此插件，请键入以下内容:</h2><h3 id="step-4-—-obtaining-an-ssl-certificate">这个运行<span> <strong> certbot </strong> </span>与<span><strong>–nginx</strong></span>插件，使用<span> <strong> -d </strong> </span>来指定我们希望证书有效的名称。</h3><p>如果这是您第一次运行<span> <strong> certbot </strong> </span>，系统会提示您输入电子邮件地址并同意服务条款。这样做之后，<span> <strong> certbot </strong> </span>将与Let's Encrypt服务器通信，然后运行一个挑战来验证您是否控制了您正在请求证书的域。</p><pre><code class="language-bash">sudo certbot --nginx -d <span class="highlight">your_domain</span> -d <span class="highlight">www.your_domain</span></code></pre><p>如果成功，certbot将询问您希望如何配置您的HTTPS设置。</p><p><span>输出</span></p><p>选择你的选择，然后点击<span>输入</span>。配置将被更新，Nginx将重新加载以获取新的设置。<span> certbot </span>将会显示一条消息，告诉您该过程已成功完成，并且您的证书存储在哪里:</p><p title="Output"><span>输出</span></p><pre><code class="language-bash">Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.  -------------------------------------------------------------------------------  1: No redirect - Make no further changes to the webserver configuration.  2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for  new sites, or if you're confident your site works on HTTPS. You can undo this  change by editing your web server's configuration.  -------------------------------------------------------------------------------  Select the appropriate number [1-2] then [enter] (press 'c' to cancel):</code></pre><p>您的证书已被下载、安装和加载。尝试使用<strong> <span> https:// </span> </strong>重新加载你的网站，并注意你的浏览器的安全指示器。它应该表明该网站是适当的安全，通常有一个绿色的锁图标。如果你用<strong> SSL实验室服务器测试</strong>来测试你的服务器，它会得到<strong> A </strong>等级。</p><p title="Output"> </p><pre><code class="language-bash">IMPORTANT NOTES:   - Congratulations! Your certificate and chain have been saved at:     /etc/letsencrypt/live/<span>your_domain</span>/fullchain.pem     Your key file has been saved at:     /etc/letsencrypt/live/<span>your_domain</span>/privkey.pem     Your cert will expire on 2019-10-08. To obtain a new or tweaked     version of this certificate in the future, simply run certbot again     with the "certonly" option. To non-interactively renew *all* of     your certificates, run "certbot renew"   - Your account credentials have been saved in your Certbot     configuration directory at /etc/letsencrypt. You should make a     secure backup of this folder now. This configuration directory will     also contain certificates and private keys obtained by Certbot so     making regular backups of this folder is ideal.   - If you like Certbot, please consider supporting our work by:       Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate     Donating to EFF:                    https://eff.org/donate-le</code></pre><pre class="code-pre"><code class="language-bash"/></pre><p class="code-pre"> </p><p><span class="ez-toc-section" id="Step_5_-_How_To_Verify_Certbot_Auto-Renewal"/>步骤5–如何验证证书自动更新<span class="ez-toc-section-end"/></p><p>Let's Encrypt的证书有效期只有<strong>九十天</strong>。这是为了鼓励用户自动化他们的证书续订过程。我们安装的<span> <strong> certbot </strong> </span>包通过向<span> <strong> /etc/cron.d </strong> </span>添加一个更新脚本来为我们处理这个问题。该脚本每天运行两次，并将自动更新任何过期三十天以内的证书。</p><h3 id="step-5-—-verifying-certbot-auto-renewal">为了测试更新过程，您可以使用<span> <strong> certbot </strong> </span>进行一次试运行:</h3><p>如果您没有看到<strong>错误</strong>，您就一切就绪了。必要时，Certbot将更新您的证书并重新加载Nginx以获取更改。如果自动续订过程失败，Let's Encrypt会向您指定的电子邮件地址发送一封邮件，在您的证书即将过期时发出警告。</p><p> </p><pre><code class="language-bash">sudo certbot renew --dry-run</code></pre><p> </p><p><span class="ez-toc-section" id="Conclusion"/>结论<span class="ez-toc-section-end"/></p><p>在本文中，通过完成以上5个步骤，你已经成功地学会了如何在<strong> Debian 10 </strong>上用Let's Encrypt来<strong>保护Nginx </strong> web服务器。此外，您还安装了Let's Encrypt客户端<span> certbot </span>，为您的域下载了SSL证书，配置Nginx使用这些证书，并设置了自动证书更新。如果你有兴趣了解更多关于这个主题的内容，可以找到我们的相关文章<a href="https://blog.eldernode.com/secure-nginx-encrypt-ubuntu/" target="_blank" rel="noopener noreferrer">如何在Ubuntu 20.04上用Let's Encrypt保护Nginx】。</a></p><h2><span class="ez-toc-section" id="Conclusion"/>Conclusion<span class="ez-toc-section-end"/></h2><p>In this article, By finishing the above 5 steps, you have successfully learned how to<strong> secure Nginx</strong> web server with Let’s Encrypt on <strong>Debian 10</strong>. Also, you installed the Let’s Encrypt client <span>certbot</span>, downloaded SSL certificates for your domain, configured Nginx to use these certificates, and set up automatic certificate renewal. If you are interested in learning more about this subject, find our related article on <a href="https://blog.eldernode.com/secure-nginx-encrypt-ubuntu/" target="_blank" rel="noopener noreferrer">How to secure Nginx with Let’s Encrypt on Ubuntu 20.04</a>.</p></div></div>    
</body>
</html>