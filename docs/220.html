<html>
<head>
<title>How to install varnish cache for Apache on CentOS/RHEL 8 - Eldernode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在CentOS/RHEL 8 - Eldernode上安装varnish cache for Apache</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/install-varnish-apache-centos/#0001-01-01">https://blog.eldernode.com/install-varnish-apache-centos/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/bf1d3170b9a119f8beaddbce0463558b.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/07/IMG_2183.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How to install varnish cache for Apache on CentOS/RHEL 8" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/07/IMG_2183.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/07/IMG_2183-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/07/IMG_2183-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/07/IMG_2183-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/07/IMG_2183-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/07/IMG_2183-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/07/IMG_2183.png"/><p>在接下来的<span> <a href="https://eldernode.com/tag/centos-8" target="_blank" rel="noopener noreferrer"> CentOS 8 </a> </span>教程中，我们将向你<strong>学习如何在CentOS/RHEL 8 </strong>上为Apache安装varnish cache。但首先，让我们知道什么是<strong>清漆缓存。</strong>它是一个免费的开源、现代和高性能的web应用程序加速器，也是一个快速反向HTTP代理，它通过将web内容存储在服务器内存(缓存)中来缓存内容以提高web服务器的性能。它被配置为在一个原始服务器如<strong>Apache</strong>(<strong>HTTPD</strong>)web server的前面运行。</p><p>您可以安全地减少未来对等请求的响应时间和网络带宽消耗，因为<strong> Varnish </strong>可以在客户端请求内容的任何时候接受<strong> HTTP </strong>请求。然后，它将请求发送到源服务器，缓存返回的对象，并回复客户端请求。下一次客户端请求相同的内容时，Varnish将从缓存中为其提供服务。</p><p><strong> Varnish </strong>的另一个有用特性是作为<strong> HTTP </strong>请求路由器、web应用防火墙、负载平衡器等等。</p><h4><span class="ez-toc-section" id="Prerequisites"/>先决条件:<span class="ez-toc-section-end"/></h4><ul><li>带有<span> <a href="https://eldernode.com/initial-set-up-centos-8/" target="_blank" rel="noopener noreferrer"> CentOS 8 </a> </span>的服务器。</li><li>在您的系统上安装了<a href="https://www.redhat.com/en/enterprise-linux-8/details#:~:text=Red%20Hat%20Enterprise%20Linux%208%20gives%20organizations%20a%20consistent%20OS,in%20management%20and%20predictive%20analytics." target="_blank" rel="noopener noreferrer"> RHEL 8 </a>并启用了Red Hat订阅的服务器</li></ul><p> </p><p><strong>您可能会感兴趣:</strong></p><p class="fjpost-title px-0"><span> <a href="https://eldernode.com/install-python-3-8-on-centos/" target="_blank" rel="noopener noreferrer">教程在Centos/RHEL 8 Linux上安装Python 3.8</a></span></p><h3/><h3><span class="ez-toc-section" id="How_to_install_varnish_cache_for_Apache_on_CentOSRHEL_8"/> <span>如何在CentOS/RHEL 8 </span>上为Apache安装varnish cache】</h3><p>在本文中，你将向你展示如何在一个新的<strong> CentOS/RHEL 8 </strong>服务器上安装<strong> Apache HTTPD </strong> web服务器和<strong> Varnish Cache 6 </strong>，包括配置Varnish在<strong> HTTPD </strong>服务器之前运行。</p><p> </p><p> </p><h3><span class="ez-toc-section" id="1-_Installing_Apache_Web_Server_on_CentOSRHEL_8"/> <span> 1-在CentOS/RHEL上安装Apache Web服务器8 </span> <span class="ez-toc-section-end"/></h3><p>首先，更新系统上安装的所有软件包。</p><pre><code class="language-bash">dnf update</code></pre><p>通过以下命令从<strong> AppStream </strong>存储库中安装<strong> Apache HTTP </strong> web服务器。</p><pre><code class="language-bash">dnf install httpd</code></pre><p class="fjpost-title px-0">安装完成后，启动httpd服务，并使其在系统引导期间自动启动。记得检查它的状态，以确认它已启动并正在运行。</p><pre><code class="language-bash">systemctl start httpd  systemctl enable httpd  systemctl status httpd</code></pre><p>您需要在防火墙中打开对HTTP服务的访问，以允许用户访问通过<strong> HTTP </strong>运行的网站或应用程序，并且还需要重新加载防火墙设置以应用新的更改，因为<strong> CentOS/RHEL 8 </strong>包括一个完全锁定的防火墙。</p><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-service=http  firewall-cmd --reload</code></pre><p> </p><h3><span class="ez-toc-section" id="2-_Installing_Varnish_Cache_64_on_CentOSRHEL_8"/> <span> 2-在CentOS/RHEL上安装清漆缓存6.4 8</span><span class="ez-toc-section-end"/></h3><p>在系统上安装<strong> Varnish Cache </strong>，因为Apache webserver正在运行。</p><pre><code class="language-bash">dnf module install varnish  </code></pre><p>完成安装后，您可以验证系统上安装的<strong> Varnish </strong>的版本。</p><pre><code class="language-bash">varnishd -V  </code></pre><p>然后，您必须将主可执行文件安装为<strong> /usr/sbin/varnishd </strong>，您会看到Varnish配置文件存储在<strong> /etc/varnish </strong>目录下，其中:</p><p><strong>1-/etc/varnish/default . vcl</strong>–是使用VCL编写的主varnish配置文件。</p><p><strong>2-/etc/varnish/secret</strong>–是varnish secret文件。</p><p>接下来，您可以启动varnish服务，并使其在服务器重启的情况下在系统引导期间自动启动，并检查其状态以确保其启动并运行，如下所示。</p><pre><code class="language-bash">systemctl start varnish  systemctl enable varnish  systemctl status varnish</code></pre><h3/><p class="fjtitle1 text-uppercase1"><span> <a href="https://eldernode.com/vps/" target="_blank" rel="noopener noreferrer"> <strong>购买虚拟私服</strong> </a> </span></p><p> </p><h3><span class="ez-toc-section" id="3-_Configuring_Apache_to_Work_with_Varnish_Cache"/> <span> 3-配置Apache使用Varnish缓存</span> <span class="ez-toc-section-end"/></h3><p>在这一步中，您必须配置<strong> Varnish缓存</strong>在Apache服务之前运行。默认情况下，Apache服务器被配置为监听端口<strong> 80 </strong>。如下所示，这是在主配置文件<strong>/etc/httpd/conf/httpd . conf</strong>中定义的。然后，使用您喜欢的文本编辑器并打开它进行编辑。</p><pre><code class="language-bash">vi /etc/httpd/conf/httpd.conf  </code></pre><p>找到<strong>监听</strong>参数。将默认端口<strong> 80 </strong>更改为<strong> 8080 </strong>或您选择的任何其他端口，以便在Apache服务器前面运行<strong> Varnish </strong>。(稍后，该端口将作为后端服务器的端口添加到Varnish配置文件中)</p><p>请考虑将通过<strong> Varnish </strong>提供服务的每个网站/应用程序的虚拟主机配置应该配置为侦听上述端口。</p><p>配置上面的端口来监听每个web站点/应用程序的虚拟主机配置，这些web站点/应用程序将通过<strong> Varnish提供服务。</strong></p><pre><code class="language-bash">&lt;<strong>VirtualHost *:8080</strong>&gt;      DocumentRoot "/var/www/html/eldernode.lan/"      ServerName www.eldernode.lan      # Other directives here  &lt;/VirtualHost&gt;  </code></pre><p><span> <strong>请注意</strong> </span>:您应该注释掉文件<strong>/etc/httpd/conf . d/welcome . conf</strong>中的所有行，或者干脆删除该文件，以防止默认的Apache HTTP server测试页面被使用。</p><pre><code class="language-bash">rm /etc/httpd/conf.d/welcome.conf</code></pre><p>现在，您可以测试httpd配置语法是否有任何错误，如果一切都<strong>正常</strong>，则重新启动httpd服务以应用新的更改。</p><pre><code class="language-bash">httpd -t  systemctl restart httpd</code></pre><h4><span class="ez-toc-section" id="Configuring_Varnish_for_Systemd"/> <span>为系统配置清漆</span> <span class="ez-toc-section-end"/></h4><p>配置Varnish在默认HTTP端口<strong> 80 </strong>监听客户端请求，如下所述，并让它部署在<strong> HTTPD </strong>的前面。</p><p>请记住，必须设置<strong>端口</strong>清漆服务器监听的清漆服务文件中的<strong>系统和<strong>清漆缓存6.0 </strong>和更高版本中的</strong>。所以打开它进行编辑。</p><pre><code class="language-bash">systemctl edit --full  varnish</code></pre><p>找到<strong> ExecStart </strong>线，然后将<strong> <span> -a </span> </strong>开关的值从<span> <strong> :6081 </strong> </span>改为<span> <strong> :80 </strong> </span>。</p><p><span> <strong>注</strong> </span> : <strong> varnishd </strong>如果<strong>没有</strong>指定地址，将监听服务器上所有可用的<strong> IPv4 </strong>和<strong> IPv6 </strong>接口。</p><pre><code class="language-bash">ExecStart=/usr/sbin/varnishd -a :6081 -f /etc/varnish/default.vcl -s malloc,256m  </code></pre><figure id="attachment_37295" class="wp-caption aligncenter" aria-describedby="caption-attachment-37295"/><p>您现在可以保存并关闭文件。</p><h4><span class="ez-toc-section" id="Configuring_Varnish_Backend_Servers_using_VCL"/> <span>使用VCL </span>配置Varnish后端服务器<span class="ez-toc-section-end"/></h4><p>是时候配置原始服务器了，在<strong> Varnish </strong>术语中称为<strong>后端</strong>。服务器理解HTTP并与Varnish对话，以获取内容——在本例中是httpd。在主配置文件<strong> /etc/varnish/default.vcl </strong>中进行配置。</p><pre><code class="language-bash">vi /etc/varnish/default.vcl   </code></pre><p>您也可以将<strong>默认</strong>改为<strong>服务器1 </strong>，因为有一个默认的<strong>后端</strong>配置段叫做<strong>默认。</strong><strong>host</strong>参数指向<strong> localhost </strong>，假设后台服务器默认运行在localhost上。现在，将端口设置为<strong> 8080 </strong>，这是Apache虚拟主机配置文件。</p><pre><code class="language-bash">backend server1 {      .host = "127.0.0.1";      .port = "8080";  }</code></pre><p>如果您的<strong>后端</strong>服务器运行在不同的主机上(地址为<strong> 10.42.1.10的另一台服务器)</strong>，主机参数应该指向这个IP地址。</p><pre><code class="language-bash">backend server1 {      .host = "10.42.1.10";      .port = "8080";  }</code></pre><p>您现在可以保存并关闭文件。</p><p>接下来，重新加载<strong> systemd </strong> manager配置，以反映Varnish服务文件中的新更改，并重新启动Varnish服务以应用整体更改。</p><pre><code class="language-bash">systemctl daemon-reload  systemctl restart varnish</code></pre><p>现在，<strong>清漆</strong>和阿帕奇现在应该分别监听端口<strong> 80 </strong>和<strong> 8080 </strong></p><pre><code class="language-bash">ss -tpln</code></pre><p> </p><p> </p><h3><span class="ez-toc-section" id="4-_Testing_Varnish_Cache_and_Apache_Setup"/> <span> 4-测试清漆缓存和Apache设置</span> <span class="ez-toc-section-end"/></h3><p>打开网络浏览器，使用服务器<strong> IP </strong>或<strong> FQDN </strong>进行导航，测试<strong>清漆缓存-HTTPD </strong>设置。</p><pre><code class="language-bash">http://10.42.0.144  OR  http://www.eldernode.lan</code></pre><p>此时，您需要检查网页是否通过<strong> Varnish缓存</strong>提供服务。要做到这一点，行动如下。</p><p>1-右键单击显示的网页，检查<strong> HTTP </strong>标题。</p><p>2-选择<strong>检查</strong>打开开发者工具</p><p>3-点击<strong>网络</strong>标签，<strong>重新加载</strong>页面</p><p>4-选择一个请求来查看HTTP标头以确认这一点</p><p>另外，您也可以使用下面的命令来验证它。</p><pre><code class="language-bash">curl -I http:///10.42.0.144  OR  curl -I http:///www.eldernode.lan</code></pre><p> </p><p> </p><h3><span class="ez-toc-section" id="Useful_Varnish_Cache_Utility_Programs"/> <span>有用的清漆缓存实用程序</span> <span class="ez-toc-section-end"/></h3><p>这里有一些<strong> Varnish Cache </strong>发行版附带的有用程序，包括用于Varnish Cache管理、显示详细日志记录和查看Varnish性能统计的实用程序，如下所述。</p><p> </p><h4><span class="ez-toc-section" id="varnishadm"/> <span>瓦内萨adm </span> <span class="ez-toc-section-end"/></h4><p>使用<strong> varnishadm </strong>来管理一个正在运行的<strong> Varnish </strong>实例。它通过建立到<strong> varnishd </strong>的命令行接口连接来工作。</p><p>此外，它可以通过启动和停止<strong> varnishd </strong>、更改配置参数、重新加载VCL、列出后端等等来影响正在运行的Varnish实例</p><pre><code class="language-bash">varnishadm  &gt; backend.list</code></pre><p> </p><h4><span class="ez-toc-section" id="varnishlog"/> <span> varnishlog </span> <span class="ez-toc-section-end"/></h4><p>您可以使用<strong> varnishlog </strong>来访问特定于请求的数据，作为关于特定客户端和请求的信息。最好对其进行过滤，因为它提供了大量信息。</p><pre><code class="language-bash">varnishlog  </code></pre><p> </p><h4><span class="ez-toc-section" id="varnishstat"/>警告状态 <span class="ez-toc-section-end"/></h4><p>您可以使用<strong> varnishstat </strong> <strong>、</strong>来访问总体统计数据，比如总请求数、对象数等等。</p><pre><code class="language-bash">varnishstat  </code></pre><p> </p><h4><span class="ez-toc-section" id="varnishtop"/>警报停止 <span class="ez-toc-section-end"/></h4><p>而<strong> varnishtop </strong>是一个实用程序，它读取<strong> Varnish </strong>日志，并呈现最常出现的日志条目的连续更新列表。</p><pre><code class="language-bash">varnishtop   </code></pre><p> </p><h4><span class="ez-toc-section" id="varnishhist"/><span/><span class="ez-toc-section-end"/></h4><p>此外，您可以使用<strong> varnishhist </strong>作为一个有用的实用程序，它读取Varnish日志并呈现一个持续更新的直方图，显示最后的<strong> N </strong>个请求的分布情况。</p><p># varnishhist <br/></p><p><span> <strong>好样的</strong> </span>！您已经成功部署了<strong> Varnish Cache </strong>来加速您在<strong> CentOS/RHEL 8 </strong>上使用<strong> Apache HTTP </strong>服务器提供的web应用内容。</p><p>亲爱的用户，我们希望本教程<strong>如何在CentOS/RHEL 8 </strong>上为Apache安装Varnish Cache对你有所帮助，如有任何问题或查看我们用户关于本文的对话，请访问<span> <a href="https://eldernode.com/ask" target="_blank" rel="noopener noreferrer">提问页面</a> </span>。也为了提高自己的见识，准备了这么多有用的教程<span> <a href="https://eldernode.com/blog/" target="_blank" rel="noopener noreferrer"> Eldernode培训</a> </span>。</p></div></div>    
</body>
</html>