<html>
<head>
<title>How to Migrate SQL Databases with Command Line - Window VPS Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何使用命令行迁移SQL数据库-windows VPS服务器</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/migrate-sql-databases/#0001-01-01">https://blog.eldernode.com/migrate-sql-databases/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/ed4b11af608c51cb63ecaa3b3834cf07.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/How-to-Migrate-SQL-Databases-with-Command-Line-1.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How to Migrate SQL Databases with Command Line" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/How-to-Migrate-SQL-Databases-with-Command-Line-1.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/08/How-to-Migrate-SQL-Databases-with-Command-Line-1-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/08/How-to-Migrate-SQL-Databases-with-Command-Line-1-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/08/How-to-Migrate-SQL-Databases-with-Command-Line-1-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/08/How-to-Migrate-SQL-Databases-with-Command-Line-1-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/08/How-to-Migrate-SQL-Databases-with-Command-Line-1-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/How-to-Migrate-SQL-Databases-with-Command-Line-1.png"/><p>如何用命令行迁移<a href="https://en.wikipedia.org/wiki/SQL"> SQL </a>数据库？今天我们想体验一下通过<span>命令行</span>使用<span> SQL数据库</span>的工作。我发现通过命令行运行一些查询来操纵一个表或创建一个数据库或查看表中的信息是非常令人愉快的。<span>本文的目的是提供一种不需要人工干预就可以导出和导入所有数据库的方法。</span></p><p> </p><p><a href="https://eldernode.com/windows-vps/"> <strong>买Windows VPS托管，便宜的Windows VPS </strong> </a></p><p> </p><h2>如何备份源服务器上的数据库</h2><p><span> <strong> 1。</strong> </span>第一步，在<strong>源服务器</strong>上打开<strong> SSMS </strong> ( <span>微软SQL Server Management Studio </span>)。</p><p><strong> a. </strong> <span>登录</span>到<strong> SQL实例</strong>并<strong>打开</strong> a <span>新建查询</span>窗口。</p><p><strong> b. </strong> <span>运行</span>下面的查询。这个命令将输出服务器上所有<span> MSSQL数据库</span>的列表。</p><pre><code class="language-bash">SELECT name FROM master.sys.databases</code></pre><p><strong> c. </strong>你可以在结果中的任意位置<strong>点击</strong>，使用键盘快捷键<span>CTRL+A</span>(Mac用户使用<span> Command + A </span>)选择所有数据库<span>将此列表</span>复制出来。</p><p><strong> d .右键单击</strong>并在高亮显示所有数据库后选择<span>复制</span>。</p><p> </p><p><strong> <span> 2。</span> </strong> <span> <span>打开<span>记事本</span>文本编辑器。</span>T9】</span></p><p><strong> a. </strong> <span>将</span>粘贴到您的结果中，并删除您不希望迁移的所有数据库(在新复制的记事本文本中)，同时删除以下条目:</p><p><span>主人</span></p><p><span>临时数据库</span></p><p><span>型号</span></p><p><span> msdb </span></p><p><strong> b. </strong>这些条目是系统的数据库，没有必要复制。</p><p> </p><p><a href="https://eldernode.com/linux-hosting/"> <strong>虚拟主机计划</strong> </a></p><p> </p><p>确保<span>删除所有内容</span>，除了您需要迁移的数据库。</p><p>现在，您应该有一个由一行分隔的所有必需数据库的列表。即</p><p><span>冒险家2012 </span></p><p><span>冒险家2014 </span></p><p><span> AdventureWorks2016 </span></p><p> </p><p><strong> <span> 3。</span> </strong> <span>将</span>这个结果在电脑上保存为<strong> C:\databases.txt </strong>。</p><p><strong> <span> 4。</span>T3创建一个<span>新记事本</span>窗口。</strong></p><p><span>复制</span> / <span>粘贴</span>以下内容到文档中<span>保存</span>为<strong> C:\db-backup.bat </strong></p><pre><code class="language-bash">mkdir %systemdrive%\dbbackups  for /F "tokens=*" %%a in (databases.txt) do ( sqlcmd.exe -Slocalhost -Q"BACKUP DATABASE %%a TO DISK ='%systemdrive%\dbbackups\%%a.bak' WITH STATS" )</code></pre><p> </p><p><strong> <span> 5。</span> </strong>在你<span>将</span>文件保存为<span> C:\db-backup.bat </span>后，导航到<span>开始菜单</span>并键入<span> cmd </span>和<strong>在<span>命令提示符</span>上右击</strong>选择<span>以管理员身份运行</span>。</p><p>键入以下命令并点击<span>回车</span>:</p><pre><code class="language-bash">cd C:\</code></pre><p> </p><p><strong>再次输入</strong> <span> db-backup.bat </span>并点击<span>回车</span>。</p><p>此时，您的数据库已经开始<span>导出</span>，您将看到每个数据库导出的进度百分比，如下图所示:</p><p> </p><p><img data-lazyloaded="1" src="../Images/9d2601696756129b6401e1ef66881708.png" decoding="async" loading="lazy" class="aligncenter wp-image-9880 size-full" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/Migrate-SQL-Databases-with-Command-Line-1.png" alt="How to Migrate SQL Databases with Command Line" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/Migrate-SQL-Databases-with-Command-Line-1.png 979w, https://blog.eldernode.com/wp-content/uploads/2020/08/Migrate-SQL-Databases-with-Command-Line-1-300x200.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/08/Migrate-SQL-Databases-with-Command-Line-1-768x511.png 768w" data-sizes="(max-width: 979px) 100vw, 979px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/Migrate-SQL-Databases-with-Command-Line-1.png"/></p><p> </p><p>注意任何<span>失败的数据库</span>，因为当它完成时，您可以重新运行批处理文件，只使用可能已经失败的数据库。</p><p>如果数据库备份失败，请注意在<span>命令提示符</span>中显示的错误消息。</p><p>通过修改现有的<strong> C:\databases.txt </strong>文件以仅包含失败的数据库，并重新运行<span> db-backup.bat </span>直到所有数据库都成功<span>导出</span>来解决错误。</p><p> </p><h2>如何将数据库恢复到目标服务器</h2><p>您有包含<span>的文件夹<strong> C:\dbbackups\ </strong>。为您想要<span>迁移</span>的每个数据库bak </span>文件。</p><p>你需要<span>复制</span>文件夹和你的<strong> C:\databases.txt </strong>文件到<span>目的服务器</span>。</p><p>有许多方法可以将数据移动到目标服务器。<span>比如</span>，可以用<strong> USB </strong>、<strong> Robocopy </strong>，或者<strong> FTP </strong>。<br/>目标服务器的<span> C </span>驱动器上的文件夹应该叫做<span> C:\dbbackups </span>。准确命名文件很重要，因为我们的脚本将寻找<span>。bak </span>文件在这里。</p><p> </p><p><a href="https://eldernode.com/vps-hosting/"> <strong> VPS托管计划</strong> </a></p><p> </p><p>如何用命令行迁移SQL数据库？</p><p>确保<span>目标服务器</span>也有您的<strong> C:\databases.txt </strong>文件，因为我们的脚本将在这里寻找数据库名称。</p><p><span> <strong> 1。</strong> </span> <span>再次打开</span>一个<span>记事本</span>文本编辑器。</p><p>然后<span>复制</span> / <span>粘贴</span>以下内容到文档中<span>保存</span>为<span> C:\db-restore.bat </span></p><pre><code class="language-bash">for /F "tokens=*" %%a in (C:\databases.txt) do (  sqlcmd.exe -E -Slocalhost -Q"RESTORE DATABASE %%a FROM DISK='%systemdrive%\dbbackups\%%a.bak' WITH RECOVERY"  )</code></pre><p> </p><p><strong> <span> 2。</span> </strong> <span>将</span>文件另存为<strong> C:\db-restore.bat </strong></p><p><strong> <span> 3。</span>导航</strong>到<span>开始菜单</span>并键入<span> cmd </span>。</p><p><strong> <span> 4。</span> </strong> <strong>在<span>命令提示符</span>上右击</strong>，选择<span>以管理员身份运行</span>。</p><p><strong> <span> 5。</span> </strong>输入下面的命令，按<span>回车</span>:</p><pre><code class="language-bash">cd C:\</code></pre><p><span> <strong> 6。</strong> </span>键入<span> db-restore.bat </span>并敲击<span>回车</span>。</p><p>您的数据库现在已经开始<span>导入</span>。</p><p>现在，您将看到每个数据库的恢复百分比，以及针对每个已成功处理的数据库的消息<span>RESTORE DATABASE successfully processed</span>。</p><p>记下任何<span>失败的数据库</span>，因为当批处理文件完成后，您可以<strong>重新运行</strong>批处理文件，只使用失败的数据库。</p><p>如果数据库<span>无法备份</span>，请记下命令提示符中显示的错误消息，解决错误(您可以根据需要更改批处理文件)，修改<strong> C:\databases.txt </strong>以仅包含失败的数据库，并重新运行<span> db-restore.bat </span>，直到所有数据库都成功导出。</p><p> </p><p><span> <strong>亦作，见:</strong> </span></p><p><a href="https://eldernode.com/install-sql-server-developer-edition-on-windows-server/">教程在Windows Server上安装SQL Server 2019开发者版</a></p><p> </p><p><strong>尊敬的用户</strong>，我们希望您能喜欢这个<a href="https://eldernode.com/category/tutorial/">教程</a>，您可以在评论区提出关于本次培训的问题，或者解决<a href="https://eldernode.com/blog/">老年人节点培训</a>领域的其他问题，请参考<a href="https://eldernode.com/ask">提问页面</a>部分，并尽快提出您的问题。腾出时间给其他用户和专家来回答你的问题。</p><p><span>好运</span>。</p><p> </p></div></div>    
</body>
</html>