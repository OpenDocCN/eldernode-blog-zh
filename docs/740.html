<html>
<head>
<title>How to setup IKev2 on centos 8 complete - Eldernode Blog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在centos 8 complete - Eldernode博客上设置IKev2</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/how-to-setup-ikev2-on-centos-8-step-by-step/#0001-01-01">https://blog.eldernode.com/how-to-setup-ikev2-on-centos-8-step-by-step/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/79fc1964f25ce7e0b8e7c14ad0ed16a2.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/05/How-to-setup-IKev2-on-centos-8-complete.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How to setup IKev2 on centos 8 complete" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/05/How-to-setup-IKev2-on-centos-8-complete.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/05/How-to-setup-IKev2-on-centos-8-complete-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/05/How-to-setup-IKev2-on-centos-8-complete-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/05/How-to-setup-IKev2-on-centos-8-complete-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/05/How-to-setup-IKev2-on-centos-8-complete-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/05/How-to-setup-IKev2-on-centos-8-complete-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/05/How-to-setup-IKev2-on-centos-8-complete.png"/><p>【更新】现在最常用的协议叫互联网密钥交换(IKE)。第一个版本发布于1998年，它的通用名称是IKEv1。因为IPsec默认使用的是IKE的第一个版本。IKEv1规范升级了它的隐藏部分，在2005年，IKEv2被创建。有了这次更新，该协议变得更加可靠，对DOS攻击更有弹性。IKEv2是一种基于IPsec的协议，代表Internet密钥交换版本2。在本文中，我们将一步一步地教你如何在centos 8 上设置IKev2。如果你想购买一台<a href="https://eldernode.com/centos-vps"> CentOS VPS </a>服务器，你可以访问<a href="https://eldernode.com/"> Eldernode </a>中提供的软件包。</p><h2><span class="ez-toc-section" id="Tutorial_Setup_IKev2_on_CentOS_8"/> <strong>教程CentOS 8上设置ike v2</strong><span class="ez-toc-section-end"/></h2><p>首先，向您介绍一下<strong> StrongSwan </strong>软件是很好的，然后，让我们来设置如何在<a href="https://blog.eldernode.com/tag/centos/"> CentOS </a> 8上设置IKev2。</p><h3><span class="ez-toc-section" id="What_is_StrongSwan"/> <strong>什么是强天鹅？</strong>T3】</h3><p>通过访问<a href="https://www.strongswan.org/" target="_blank" rel="noopener noreferrer"> Strongswan网站</a>，您将认识到，Strongswan是一个开源的多平台IPsec实现。这是一个基于IPsec的VPN解决方案，侧重于强认证机制。StrongSwan支持<strong> IKEv1 </strong>和<strong> IKEv2 </strong>密钥交换协议、基于X.509证书或预共享密钥的认证以及安全的IKEv2 EAP用户认证。</p><p>在阅读了<strong>什么是StrongSwan </strong>部分之后，现在我们将一步一步地教你如何在centos 8上设置IKev2，最后在CentOS 8上运行VPN服务器。</p><h3><span class="ez-toc-section" id="Prerequisites_to_Setup_IKev2_on_CentOS_8"/>在CentOS 8上设置IKev2的先决条件<span class="ez-toc-section-end"/></h3><p>在CentOS 8上启动IKev 2之前，务必准备好以下先决条件。准备好这些先决条件后，您可以按照下一节中的设置步骤进行操作:</p><p>_全新CentOS 8服务器</p><p>_ Root权限</p><h2><span class="ez-toc-section" id="How_to_setup_IKev2_on_CentOS_8"/> <strong>如何在CentOS 8上设置ike v2</strong>T3】</h2><p>要在centos 8上设置IKev2，您需要按顺序遵循以下章节。</p><h3><span class="ez-toc-section" id="Install_StrongSwan_on_CentOS_8"/> <strong>在CentOS 8 </strong> <span class="ez-toc-section-end"/>上安装StrongSwan</h3><p>在第一步中，我们将安装Strongswan IPsec实施软件和EPEL存储库中所需的所有软件包。因此<strong>使用以下命令添加EPEL回购</strong>:</p><pre><code class="language-bash">dnf install epel-release</code></pre><p>EPEL库安装成功后，运行以下命令<strong>安装stronswan</strong>:</p><pre><code class="language-bash">dnf install strongswan</code></pre><h3><span class="ez-toc-section" id="Generate_SSL_Certificate_by_Lets_Encrypt"/> <strong>生成SSL证书让我们加密</strong> <span class="ez-toc-section-end"/></h3><p>要生成证书，您需要一个域和一个子域指向此服务器。所以我们在我们的域名系统上选择<strong>vpn.eldernode.com</strong>记录，你必须选择你的记录并替换我们使用我们域名的所有记录。</p><p>首先，您需要使用以下命令安装<a href="https://letsencrypt.org/" target="_blank" rel="nofollow noopener noreferrer">让我们加密</a> bot:</p><pre><code class="language-bash">wget https://dl.eff.org/certbot-auto -O /usr/local/bin/certbot-auto</code></pre><p>之后，使用以下命令使其可执行:</p><pre><code class="language-bash">chmod +x /usr/local/bin/certbot-auto</code></pre><p>现在certbot工具安装完毕，可以为您的服务器生成SSL了。</p><p>要使用let's encrypt生成SSL，您需要打开HTTP和HTTPS端口，对于此指令，请遵循以下命令:</p><pre><code class="language-bash">firewall-cmd --add-service=http --permanent  </code></pre><pre><code class="language-bash">firewall-cmd --add-service=https --permanent</code></pre><pre><code class="language-bash">firewall-cmd --reload</code></pre><p><span>记住</span>不要关闭或禁用<a href="https://blog.eldernode.com/configure-firewalld-on-centos-8/" target="_blank" rel="noopener noreferrer">防火墙</a>，因为我们稍后需要防火墙服务。</p><p>现在，您可以为您的VPN服务器生成一个新的SSL并获得一个证书文件:</p><pre><code class="language-bash">certbot-auto certonly --rsa-key-size 2048 --standalone --agree-tos --no-eff-email --email your <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="89e4e8e0e5c9ede6e4e8e0e7a7eae6e4">[email protected]</a> -d <span>vpn.eldernode.com</span></code></pre><p><em> <b>注:</b> </em>请将邮箱改为您的邮箱，将vpn.eldernode.com改为您的域名。</p><p>完成命令后，您会看到祝贺！现在使用您的SSL证书</p><p>接下来，您需要将证书文件'<strong> <em> fullchain.pem </em> </strong>'、'<strong> <em> privkey.pem </em> </strong>'和'<strong> <em> chain.pem </em> </strong>'复制到'<strong>/etc/strong swan/IPSec . d/</strong>'目录中。</p><pre><code class="language-bash">cp /etc/letsencrypt/live/vpn.eldernode.com/fullchain.pem /etc/strongswan/ipsec.d/certs/  </code></pre><pre><code class="language-bash">cp /etc/letsencrypt/live/vpn.eldernode.com/privkey.pem /etc/strongswan/ipsec.d/private/  </code></pre><pre><code class="language-bash">cp /etc/letsencrypt/live/vpn.eldernode.com/chain.pem /etc/strongswan/ipsec.d/cacerts/</code></pre><p>我们使用我们的域名，所以certbot用我们的服务器名为SSL创建一个目录。对于您，certbot在您的域名目录上创建并生成SSL。</p><h3><span class="ez-toc-section" id="How_to_Configure_StrongSwan_as_IKev2_VPN_Server"/> <strong>如何将StrongSwan配置为IKev2 VPN服务器</strong> <span class="ez-toc-section-end"/></h3><p>转到<strong> /etc/strongswan </strong>目录，使用以下命令从<strong> ipsec.conf，</strong>进行备份:</p><pre><code class="language-bash">cd /etc/strongswan  </code></pre><pre><code class="language-bash">mv ipsec.conf ipsec.conf.original</code></pre><p>之后，使用以下命令创建一个新的ipsec.conf:</p><pre><code class="language-bash">vi ipsec.conf</code></pre><p>您可以使用centos 8上的任何编辑器，如vim或<a href="https://blog.eldernode.com/how-to-install-and-use-nano-text-editor/"> nano </a>来创建和编辑文件。然后在ipsec.conf文件中复制并粘贴以下配置:</p><pre><code class="language-bash">config setup      uniqueids=never # for allow multiple connections per user      charondebug="ike 2, knl 2, cfg 2, net 2, esp 2, dmn 2,  mgr 2"  conn %default      fragmentation=yes      closeaction=restart      rekey=no      dpdaction=clear      keyexchange=ikev2      compress=yes      dpddelay=35s      lifetime=3h      ikelifetime=12h      ike=aes256gcm16-prfsha512-ecp384!      esp=aes256gcm16-ecp384!      left=%any      <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8be7eeedffe2efb6cbfdfbe5a5eee7efeef9e5e4efeea5e8e4e6">[email protected]</a>      leftcert=fullchain.pem      leftsendcert=always      leftsubnet=0.0.0.0/0      right=%any      rightid=%any      rightauth=eap-mschapv2      rightsourceip=192.168.20.0/24      rightdns=1.1.1.1,8.8.4.4      rightsendcert=never      eap_identity=%identity  conn ikev2-pubkey      auto=add</code></pre><p><em> <b>注意:</b> </em>替换您的域名而不是我们配置上的域名。</p><p>之后，<strong>保存</strong>并退出文件。现在，我们想创建一些连接到服务器的用户。所以下面的命令打开<strong> ipsec.secret </strong>文件:</p><pre><code class="language-bash">vi ipsec.secrets</code></pre><p>将以下配置复制并粘贴到文件上，然后<strong>保存</strong>并退出。有关更多信息，您可以添加更多用户，如配置中的所示:</p><pre><code class="language-bash">: RSA "privkey.pem"  alex : EAP "<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="cfaea3aab78ffbbdaafb">[email protected]</a>"  john : EAP "johni#poe"</code></pre><p><strong>用下面的命令使能</strong>和<strong>启动StrongSwan </strong>服务:</p><pre><code class="language-bash">systemctl enable strongswan  </code></pre><pre><code class="language-bash">systemctl start strongswan</code></pre><p>现在Strongswan服务已激活并运行，您可以使用以下命令进行检查:</p><pre><code class="language-bash">systemctl status strongswan</code></pre><h3><span class="ez-toc-section" id="How_to_Enable_NAT_in_Firewalld"/> <strong>如何在防火墙中启用NAT</strong><span class="ez-toc-section-end"/></h3><p>在之前的文章中，我们介绍了Firewalld并学习了如何使用它。如果你需要了解防火墙，你可以阅读centos 8 上的<a href="https://blog.eldernode.com/configure-firewalld-on-centos-8/" target="_blank" rel="noopener noreferrer">配置防火墙。</a></p><p>在这一步中，您将使用丰富的规则配置在Firewalld上启用AH、ESP和NAT伪装。您可以使用以下命令添加<strong> ipsec UDP端口和服务</strong>:</p><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-port=4500/udp  </code></pre><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-port=500/udp  </code></pre><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-service="ipsec"</code></pre><p>然后，您可以通过执行以下认证和加密协议命令，将<strong> AH </strong>和<strong> ESP </strong>添加到Firewalld:</p><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-rich-rule='rule protocol value="esp" accept'  </code></pre><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-rich-rule='rule protocol value="ah" accept'</code></pre><p>现在<strong>启用NAT </strong>并重新加载防火墙配置规则:</p><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-masquerade  </code></pre><pre><code class="language-bash">firewall-cmd --reload</code></pre><h3><span class="ez-toc-section" id="How_to_Enable_port-forwarding_on_sysctl"/> <strong>如何在sysctl</strong>T3上启用端口转发</h3><p>要在CentOS 8上启用端口转发，需要编辑<strong> sysctl.conf </strong>文件。首先，用下面的命令编辑<strong> /etc/sysctl.conf </strong>文件:</p><pre><code class="language-bash">vi /etc/sysctl.conf</code></pre><p>用编辑器打开文件后，复制并粘贴以下配置，<strong>保存</strong>，并退出:</p><pre><code class="language-bash">net.ipv4.ip_forward = 1  net.ipv4.conf.all.accept_redirects = 0  net.ipv4.conf.all.send_redirects = 0</code></pre><p>您需要使用以下命令重新加载sysctl配置:</p><pre><code class="language-bash">sysctl -p</code></pre><p>现在端口转发已启用，您只需<strong>重启Strongswan </strong>服务:</p><pre><code class="language-bash">systemctl restart strongswan</code></pre><p>太好了。CentOS 8上的IKev2 VPN服务器已准备就绪，您可以在iPhone、Windows、android Strongswan应用程序、iMac等上使用它。</p><h2><span class="ez-toc-section" id="Conclusion"/>结论<span class="ez-toc-section-end"/></h2><p>在本文中，我们试图一步一步地向您介绍如何在centos 8上设置IKev2。现在，如果您有任何问题，可以在下面的页面上发表评论，或者在<a href="https://community.eldernode.com/" target="_blank" rel="noopener noreferrer"> Eldernode社区</a>上提出您的问题。</p></div></div>    
</body>
</html>