<html>
<head>
<title>How to Secure Apache with Let's Encrypt on Debian 10 - Eldernode</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何用让我们在Debian 10 - Eldernode上加密来保护Apache</h1>
<blockquote>原文：<a href="https://blog.eldernode.com/secure-apache-debian-10/#0001-01-01">https://blog.eldernode.com/secure-apache-debian-10/#0001-01-01</a></blockquote><div><div class="blog-details">                                  <img data-lazyloaded="1" src="../Images/7ea7f3f0c16ce5fa7f7f2a9ccb51c409.png" data-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2054.png" class="img-fluid mb-3 shadow-sm round-10 wp-post-image" alt="How to Secure Apache with Let's Encrypt on Debian 10" decoding="async" data-srcset="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2054.png 2069w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2054-300x164.png 300w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2054-1024x561.png 1024w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2054-768x421.png 768w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2054-1536x842.png 1536w, https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2054-2048x1122.png 2048w" data-sizes="(max-width: 2069px) 100vw, 2069px" data-original-src="https://blog.eldernode.com/wp-content/uploads/2020/08/IMG_2054.png"/><p><span> Let's Encrypt是一个证书颁发机构(CA ),它提供了一种简单的方法来获取和安装免费的<a href="https://eldernode.com/how-to-install-and-activate-the-ssl-certificate/" target="_blank" rel="noopener noreferrer"> TLS/SSL证书</a>,从而在web服务器上启用加密HTTPS。它通过提供一个软件客户端<a href="https://certbot.eff.org/" target="_blank" rel="noopener noreferrer"> Certbot </a>来简化流程，该客户端试图自动执行大多数(如果不是全部)所需的步骤。目前，获得和安装证书的整个过程在Apache和<a href="https://eldernode.com/install-nginx-debian-10/" target="_blank" rel="noopener noreferrer"> Nginx </a>上都是完全自动化的。</span></p><p>在本指南中，我们将使用一个单独的Apache <a href="https://eldernode.com/linux-vps/" target="_blank" rel="noopener noreferrer">虚拟主机</a>文件，而不是默认配置文件。<a href="https://eldernode.com/install-apache-web-server-debian/" target="_blank" rel="noopener noreferrer">我们建议</a>为每个域创建新的Apache虚拟主机文件，因为这有助于避免常见错误，并保留默认文件作为后备配置。</p><p> </p><p>为了让本教程更好地工作，请考虑下面的<strong>先决条件:</strong></p><ul><li><span>完全注册的域名。本教程将始终使用<strong> your_domain </strong>作为例子。你可以在<strong> Namecheap </strong>上购买一个域名，在<strong> Freenom </strong>上免费获得一个，或者使用你选择的域名注册商。</span></li><li><span>为您的服务器设置了以下两个DNS记录。要设置这些，你可以按照这些说明添加域名，然后按照这些说明创建<strong> DNS记录</strong>。</span><ul><li><span>一个A记录，其中<strong> your_domain </strong>指向你的服务器的公共IP地址。</span></li><li><span>一个带有<strong> www.your_domain </strong>的A记录指向你的服务器的公共IP地址。</span></li></ul></li><li><span> Apache安装遵循<a href="https://eldernode.com/install-apache-web-server-debian/" target="_blank" rel="noopener noreferrer">如何在Debian 10上安装Apache</a>。确保为您的域设置了虚拟主机文件。本教程将以/etc/Apache 2/sites-available/your _ domain . conf为例。</span></li></ul><p> </p><p><span> </span></p><h2><span class="ez-toc-section" id="How_to_Secure_Apache_with_Lets_Encrypt_on_Debian_10"/> <span>如何在Debian 10上用Let's Encrypt保护Apache</span><span class="ez-toc-section-end"/></h2><p>在本教程中，您将使用Certbot为Debian 10上的Apache获取一个免费的SSL证书，并设置您的证书自动更新。所以加入我们，开始学习如何用Debian 10 上的Let ' s Encrypt<strong>来保护Apache </strong>。</p><p> </p><h3><span class="ez-toc-section" id="1-_How_To_Install_Certbot"/> <span> 1-如何安装Certbot </span> <span class="ez-toc-section-end"/></h3><p><span>首先，使用Let's Encrypt获得SSL证书就是在你的服务器上安装Certbot软件。</span></p><p>在撰写本文时，默认情况下，Debian软件仓库中没有Certbot。为了使用apt下载软件，您需要将backports存储库添加到sources.list文件中，apt在该文件中查找软件包源代码。Backports是来自Debian的测试和不稳定发行版的包，它们被重新编译，所以它们可以在稳定的Debian发行版上运行，而不需要新的库。</p><p><span>要添加backports存储库，请打开(或创建)您的/etc/apt/目录中的sources.list文件:</span></p><pre><code class="language-bash"><span>sudo nano /etc/apt/sources.list</span></code></pre><p><span>在文件的底部，添加下面一行:</span></p><p class="code-label" title="/etc/apt/sources.list.d/sources.list"><span>/etc/apt/sources . list . d/sources . list</span></p><pre><code class="language-bash"><span>. . .  deb http://mirrors.digitalocean.com/debian buster-backports main  deb-src http://mirrors.digitalocean.com/debian buster-backports main  deb http://ftp.debian.org/debian buster-backports main</span></code></pre><p>这包括符合Debian自由软件指南(DFSG)的主软件包，以及非自由和contrib组件，这些组件或者本身不符合DFSG标准，或者包含这一类别中的依赖项。</p><p><span>通过按CTRL+X，Y保存并关闭文件，然后输入，然后更新您的包列表:</span></p><pre><code class="language-bash"><span>sudo apt update</span></code></pre><p><span>接下来，使用以下命令安装Certbot。注意-t选项告诉apt通过在刚刚添加的backports存储库中查找来搜索包:</span></p><pre><code class="language-bash"><span>sudo apt install python-certbot-apache -t buster-backports</span></code></pre><p><span> Certbot现在<strong>准备好</strong>使用，但是为了让它为<strong> Apache </strong>配置SSL，我们需要验证Apache已经被正确配置。</span></p><pre><code class="language-bash"/></pre><h3/><h3 id="step-2-—-setting-up-the-ssl-certificate"><span class="ez-toc-section" id="2-_How_To_Set_Up_The_SSL_Certificate"/> <span> 2-如何设置SSL证书</span> <span class="ez-toc-section-end"/></h3><p>为了自动配置SSL，Certbot需要能够在Apache配置中为它找到正确的虚拟主机。具体来说，它通过查找与您请求证书的域相匹配的ServerName指令来实现这一点。</p><p><span>如果您遵循了<a href="https://eldernode.com/install-apache-web-server-debian/" target="_blank" rel="noopener noreferrer">如何在Debian 10 </a>上安装Apache，您应该在/etc/Apache 2/sites available/your _ domain . conf中有一个虚拟主机块，并且已经适当地设置了ServerName指令。</span></p><p><span>当然，你可以通过使用<strong> nano </strong>或者你喜欢的文本编辑器:</span>打开你的域的虚拟主机文件来检查</p><pre><code class="language-bash"><span>sudo nano /etc/apache2/sites-available/<span class="highlight">your_domain</span>.conf</span></code></pre><p>之后，尝试找到现有的<strong> S </strong> erverName线路。应该是这样的，用你自己的域名代替你的_domain: </p><p class="code-label" title="/etc/apache2/sites-available/your_domain.conf"><span>/etc/Apache 2/sites-available/your _ domain . conf</span></p><pre><code class="language-bash"><span>...  ServerName your_domain;  ...</span></code></pre><p>首先，检查一下，如果还没有，更新ServerName指令指向你的域名。然后保存文件，退出编辑器，并验证配置编辑的语法:</p><pre><code class="language-bash"><span>sudo apache2ctl configtest</span></code></pre><p title="Output"><span>输出</span></p><pre><code class="language-bash"><span>Syntax OK</span></code></pre><p>面对任何错误，重新打开虚拟主机文件，并检查是否有任何打字错误或丢失的字符。一旦配置文件的语法正确，重新加载Apache来加载新的配置:</p><pre><code class="language-bash"><span>sudo systemctl reload apache2</span></code></pre><pre><code class="language-bash"/></pre><p> </p><h3 id="step-3-—-allowing-https-through-the-firewall"><span class="ez-toc-section" id="3-_How_To_Allow_HTTPS_Through_the_Firewall"/> <span> 3-如何允许HTTPS通过防火墙</span> <span class="ez-toc-section-end"/></h3><p><span>根据必备指南，如果您启用了ufw防火墙，您需要调整设置以允许HTTPS流量。幸运的是，当安装在Debian上时，ufw附带了一些配置文件，有助于简化为HTTP和HTTPS流量更改防火墙规则的过程。</span></p><p><span>并查看当前设置:</span></p><pre><code class="language-bash"><span>sudo ufw status</span></code></pre><p><span>下面的输出显示只允许HTTP流量进入web服务器:</span></p><p title="Output"><span>输出</span></p><pre><code class="language-bash"><span>Status: active    To                         Action      From  --                         ------      ----  OpenSSH                    ALLOW       Anywhere                    WWW                        ALLOW       Anywhere                    OpenSSH (v6)               ALLOW       Anywhere (v6)               WWW (v6)                   ALLOW       Anywhere (v6)</span></code></pre><p><span>接下来，为了额外引入HTTPS流量，允许“WWW满”配置文件并删除多余的“WWW”配置文件允许量:</span></p><pre><code class="language-bash"><span>sudo ufw allow 'WWW Full'  sudo ufw delete allow 'WWW'</span></code></pre><p>然后，您将收到以下状态。</p><pre><code class="language-bash"><span>sudo ufw status</span></code></pre><p title="Output"><span>输出</span></p><pre><code class="language-bash"><span>Status: active    To                         Action      From  --                         ------      ----  OpenSSH                    ALLOW       Anywhere                    WWW Full                   ALLOW       Anywhere                    OpenSSH (v6)               ALLOW       Anywhere (v6)               WWW Full (v6)              ALLOW       Anywhere (v6)</span></code></pre><p><span class="ez-toc-section" id="4-_How_To_Obtain_an_SSL_Certificate"/> <span> 4-如何获得SSL证书</span> <span class="ez-toc-section-end"/></p><p>由于Apache插件会负责重新配置Apache并在必要时重新加载配置，您可以使用下面的命令来使用这个插件。另外，Certbot提供了多种通过插件获得SSL证书的方法。</p><h3 id="step-4-—-obtaining-an-ssl-certificate"><span>这会运行<strong> certbot </strong>和<strong>–Apache</strong>插件，使用<strong> -d </strong>来指定您希望证书有效的名称。</span></h3><p><span>这是你第一次运行<strong> certbot？所以</strong>你会被提示输入一个电子邮件地址并同意服务条款。此外，它还会询问你是否愿意与电子前沿基金会(T4)分享你的电子邮件地址，这是一个倡导数字权利的非营利组织，也是Certbot的制造商。请随意输入<strong> Y </strong>分享您的电子邮件地址或<strong> N </strong>拒绝。</span></p><pre><code class="language-bash"><span>sudo certbot --apache -d <span class="highlight">your_domain</span> -d <span class="highlight">www.your_domain</span></span></code></pre><p><span>这样做之后，<strong> certbot </strong>将与Let's Encrypt服务器通信，然后运行一个挑战来验证您是否控制了您正在申请证书的域。</span></p><p><span>如果成功，certbot将询问您希望如何配置您的HTTPS设置:</span></p><p><span>输出</span></p><p>现在，选择你的选择，然后点击<strong>进入</strong>。配置将自动更新，Apache将重新加载以获取新的设置。<strong> certbot </strong>将会以一条消息结束，告诉你这个过程已经成功，你的证书存放在哪里:</p><p title="Output"><span>输出</span></p><pre><code class="language-bash"><span>Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.  -------------------------------------------------------------------------------  1: No redirect - Make no further changes to the webserver configuration.  2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for  new sites, or if you're confident your site works on HTTPS. You can undo this  change by editing your web server's configuration.  -------------------------------------------------------------------------------  Select the appropriate number [1-2] then [enter] (press 'c' to cancel):</span></code></pre><p><span>在下载、安装和加载您的证书时，您可以使用<strong> https:// </strong>重新加载您的网站，并注意浏览器的安全指示器。它应该表明该网站是适当的安全，通常有一个绿色的锁图标。如果你使用<strong> SSL实验室服务器测试</strong>来测试你的服务器，它会得到<strong> A </strong>等级。</span></p><p title="Output"><span>Output</span></p><pre><code class="language-bash"><span>IMPORTANT NOTES:   - Congratulations! Your certificate and chain have been saved at:     /etc/letsencrypt/live/your_domain/fullchain.pem     Your key file has been saved at:     /etc/letsencrypt/live/your_domain/privkey.pem     Your cert will expire on 2019-10-20. To obtain a new or tweaked     version of this certificate in the future, simply run certbot again     with the "certonly" option. To non-interactively renew *all* of     your certificates, run "certbot renew"   - Your account credentials have been saved in your Certbot     configuration directory at /etc/letsencrypt. You should make a     secure backup of this folder now. This configuration directory will     also contain certificates and private keys obtained by Certbot so     making regular backups of this folder is ideal.   - If you like Certbot, please consider supporting our work by:       Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate     Donating to EFF:                    https://eff.org/donate-le</span></code></pre><p><span> </span></p><p><span class="ez-toc-section" id="5-_How_To_Verify_Certbot_Auto-Renewal"/> <span> 5-如何验证证书自动更新</span> <span class="ez-toc-section-end"/></p><h2><span>咱们加密的证书有效期只有九十天。这是为了鼓励用户自动化他们的证书续订过程。我们安装的<strong> certbo </strong> t包通过向/etc/cron.d添加一个更新脚本来为我们解决这个问题。这个脚本每天运行两次，并将自动更新任何30天内到期的证书。</span></h2><p><span>使用certbot进行试运行，以测试更新过程。</span></p><h3 id="step-5-—-verifying-certbot-auto-renewal">为了不出现错误，你已经准备好了。此外，Certbot将更新您的证书，并在必要时重新加载Apache以获取更改。如果自动续订过程失败，Let's Encrypt会向您指定的电子邮件地址发送一封邮件，在您的证书即将过期时发出警告。</h3><p> </p><p> </p><pre><code class="language-bash"><span>sudo certbot renew --dry-run</span></code></pre><p><span class="ez-toc-section" id="Conclusion"/>结论<span class="ez-toc-section-end"/></p><p>在本文中，您了解了如何<span>安装Let's Encrypt客户端<strong> certbot </strong>，为您的域下载SSL证书，配置Apache使用这些证书，以及设置自动证书更新。如果您对使用Certbot有进一步的疑问，他们的文档是一个很好的起点。如果你有兴趣<a href="https://blog.eldernode.com/secure-nginx-encrypt-ubuntu/" target="_blank" rel="noopener noreferrer">阅读更多关于这个主题的</a>，看看其他相关的<a href="https://blog.eldernode.com/secure-apache-lets-encrypt-ubuntu-20/" target="_blank" rel="noopener noreferrer">文章</a>。</span></p><p> </p><h2><span class="ez-toc-section" id="Conclusion"/>Conclusion<span class="ez-toc-section-end"/></h2><p>In this article, you learned how<span> to install the Let’s Encrypt client <strong>certbot</strong>, downloaded SSL certificates for your domain, configured Apache to use these certificates, and set up automatic certificate renewal. If you have further questions about using Certbot, their documentation is a good place to start. In case you are interested in <a href="https://blog.eldernode.com/secure-nginx-encrypt-ubuntu/" target="_blank" rel="noopener noreferrer">reading more</a> about this subject, have a look at other related <a href="https://blog.eldernode.com/secure-apache-lets-encrypt-ubuntu-20/" target="_blank" rel="noopener noreferrer">articles</a>.</span></p></div></div>    
</body>
</html>